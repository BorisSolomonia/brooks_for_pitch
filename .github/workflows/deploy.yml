name: Deploy Brooks App

on:
  push:
    branches: [main, master]
  workflow_dispatch:

concurrency:
  group: deploy-brooks
  cancel-in-progress: false

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: ${{ secrets.GCP_REGION }}
  REPOSITORY: ${{ secrets.GCP_ARTIFACT_REPOSITORY }}
  ENV_SECRET_NAME: ${{ secrets.GCP_ENV_SECRET_NAME }}
  VM_HOST: 34.59.248.42
  VM_NAME: instance-20260213-212636
  VM_ZONE: us-central1-a

jobs:
  handshake:
    name: VM Handshake
    runs-on: ubuntu-latest
    steps:
      - name: SSH handshake
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.VM_HOST }}
          username: ${{ secrets.VM_SSH_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: 22
          timeout: 20s
          command_timeout: 20s
          script: |
            set -e
            echo "SSH handshake successful"
            echo "Host: $(hostname)"
            echo "User: $(whoami)"
            echo "UTC:  $(date -u)"

  deploy:
    name: Build and Redeploy
    runs-on: ubuntu-latest
    needs: handshake

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Auth to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Resolve required variables
        run: |
          set -euo pipefail
          [ -n "${PROJECT_ID}" ] || { echo "PROJECT_ID is empty"; exit 1; }
          [ -n "${REGION}" ] || { echo "REGION is empty"; exit 1; }
          [ -n "${REPOSITORY}" ] || { echo "REPOSITORY is empty"; exit 1; }
          [ -n "${ENV_SECRET_NAME}" ] || { echo "ENV_SECRET_NAME is empty"; exit 1; }

      - name: Fetch env from Secret Manager
        run: |
          set -euo pipefail
          gcloud secrets versions access latest \
            --secret="${ENV_SECRET_NAME}" \
            --project="${PROJECT_ID}" > .env.production

      - name: Normalize and validate DB env
        run: |
          set -euo pipefail

          # Keep DB URLs runtime-compatible in containers.
          sed -E -i '/^[A-Z_]+_DB_URL=/{
            s#sslmode=verify-full#sslmode=require#g;
            s#([?&])sslrootcert=[^&]*##g;
            s#\?&+#?#g;
            s#&&+#\&#g;
            s#[?&]$##g;
          }' .env.production

          for svc in AUTH SOCIAL LISTS PINS MODERATION; do
            url="$(grep -E "^${svc}_DB_URL=" .env.production | cut -d'=' -f2- || true)"
            user="$(grep -E "^${svc}_DB_USER=" .env.production | cut -d'=' -f2- || true)"
            pass="$(grep -E "^${svc}_DB_PASSWORD=" .env.production | cut -d'=' -f2- || true)"

            [ -n "$url" ] || { echo "Missing ${svc}_DB_URL"; exit 1; }
            [ -n "$user" ] || { echo "Missing ${svc}_DB_USER"; exit 1; }
            [ -n "$pass" ] || { echo "Missing ${svc}_DB_PASSWORD"; exit 1; }

            echo "$url" | grep -Eq '^jdbc:postgresql://' || {
              echo "${svc}_DB_URL must start with jdbc:postgresql://";
              exit 1;
            }

            echo "$url" | grep -Eq 'jdbc:postgresql://(localhost|127\.0\.0\.1|\[::1\]|::1)(:|/|$)' && {
              echo "${svc}_DB_URL points to localhost; invalid inside containers";
              exit 1;
            }
            echo "$url" | grep -Eq 'jdbc:postgresql://postgres(:|/|$)' && {
              echo "${svc}_DB_URL points to host postgres; invalid unless local DB service exists";
              exit 1;
            }

            if echo "$url" | grep -q 'pooler.supabase.com:6543'; then
              echo "${svc}_DB_URL uses Supabase transaction pooler (6543) which is incompatible with HikariCP+Flyway. Use session pooler: pooler.supabase.com:5432"
              exit 1
            fi
          done

      - name: Configure Docker for Artifact Registry
        run: |
          set -euo pipefail
          gcloud auth configure-docker ${REGION}-docker.pkg.dev --quiet

      - name: Build and push backend images
        run: |
          set -euo pipefail

          build_push() {
            local service_dir="$1"
            local image_name="$2"
            local env_key="$3"
            local image_path="${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPOSITORY}/${image_name}"

            docker build \
              --progress=plain \
              --build-arg SERVICE_DIR="${service_dir}" \
              -f infra/docker/Dockerfile.service \
              -t "${image_path}:${GITHUB_SHA}" \
              -t "${image_path}:latest" \
              .

            docker push "${image_path}:${GITHUB_SHA}"
            docker push "${image_path}:latest"

            echo "${env_key}=${image_path}:${GITHUB_SHA}" >> "$GITHUB_ENV"
          }

          build_push "services/auth-service" "brooks-auth-service" "BROOKS_AUTH_IMAGE"
          build_push "services/social-service" "brooks-social-service" "BROOKS_SOCIAL_IMAGE"
          build_push "services/lists-service" "brooks-lists-service" "BROOKS_LISTS_IMAGE"
          build_push "services/pins-service" "brooks-pins-service" "BROOKS_PINS_IMAGE"
          build_push "services/media-service" "brooks-media-service" "BROOKS_MEDIA_IMAGE"
          build_push "services/moderation-service" "brooks-moderation-service" "BROOKS_MODERATION_IMAGE"
          build_push "services/notifications-service" "brooks-notifications-service" "BROOKS_NOTIFICATIONS_IMAGE"

      - name: Build and push frontend image
        run: |
          set -euo pipefail
          IMAGE_PATH="${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPOSITORY}/brooks-frontend"

          get_env() {
            local key="$1"
            grep "^${key}=" .env.production | cut -d'=' -f2- | tr -d '"' | tr -d "'" || true
          }

          docker build \
            --progress=plain \
            --build-arg VITE_AUTH_API_URL="$(get_env VITE_AUTH_API_URL)" \
            --build-arg VITE_AUTH0_DOMAIN="$(get_env VITE_AUTH0_DOMAIN)" \
            --build-arg VITE_AUTH0_CLIENT_ID="$(get_env VITE_AUTH0_CLIENT_ID)" \
            --build-arg VITE_AUTH0_AUDIENCE="$(get_env VITE_AUTH0_AUDIENCE)" \
            --build-arg VITE_AUTH0_REDIRECT_URI="$(get_env VITE_AUTH0_REDIRECT_URI)" \
            --build-arg VITE_SOCIAL_API_URL="$(get_env VITE_SOCIAL_API_URL)" \
            --build-arg VITE_LISTS_API_URL="$(get_env VITE_LISTS_API_URL)" \
            --build-arg VITE_PINS_API_URL="$(get_env VITE_PINS_API_URL)" \
            --build-arg VITE_MEDIA_API_URL="$(get_env VITE_MEDIA_API_URL)" \
            --build-arg VITE_MODERATION_API_URL="$(get_env VITE_MODERATION_API_URL)" \
            --build-arg VITE_NOTIFICATIONS_API_URL="$(get_env VITE_NOTIFICATIONS_API_URL)" \
            --build-arg VITE_MAP_PROVIDER="$(get_env VITE_MAP_PROVIDER)" \
            --build-arg VITE_GOOGLE_MAPS_KEY="$(get_env VITE_GOOGLE_MAPS_KEY)" \
            --build-arg VITE_NOMINATIM_URL="$(get_env VITE_NOMINATIM_URL)" \
            --build-arg VITE_LEAFLET_TILE_URL="$(get_env VITE_LEAFLET_TILE_URL)" \
            --build-arg VITE_LEAFLET_ATTRIBUTION="$(get_env VITE_LEAFLET_ATTRIBUTION)" \
            --build-arg VITE_DEFAULT_CENTER_LAT="$(get_env VITE_DEFAULT_CENTER_LAT)" \
            --build-arg VITE_DEFAULT_CENTER_LNG="$(get_env VITE_DEFAULT_CENTER_LNG)" \
            -f web/Dockerfile \
            -t "${IMAGE_PATH}:${GITHUB_SHA}" \
            -t "${IMAGE_PATH}:latest" \
            web/

          docker push "${IMAGE_PATH}:${GITHUB_SHA}"
          docker push "${IMAGE_PATH}:latest"

          echo "BROOKS_FRONTEND_IMAGE=${IMAGE_PATH}:${GITHUB_SHA}" >> "$GITHUB_ENV"

      - name: Prepare VM upload directories
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.VM_HOST }}
          username: ${{ secrets.VM_SSH_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: 22
          timeout: 60s
          command_timeout: 120s
          script: |
            set -e
            if ! command -v docker >/dev/null 2>&1; then
              sudo apt-get update
              sudo apt-get install -y ca-certificates curl gnupg lsb-release
              sudo install -m 0755 -d /etc/apt/keyrings
              curl -fsSL https://download.docker.com/linux/debian/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
              sudo chmod a+r /etc/apt/keyrings/docker.gpg
              echo \
                "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian \
                $(. /etc/os-release && echo \"$VERSION_CODENAME\") stable" | \
                sudo tee /etc/apt/sources.list.d/docker.list >/dev/null
              sudo apt-get update
              sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
              sudo systemctl enable docker
              sudo systemctl start docker
            fi
            sudo mkdir -p /opt/brooks
            sudo mkdir -p /opt/brooks/infra/caddy
            sudo mkdir -p /opt/brooks/infra/db/init
            sudo chown -R "$USER:$USER" /opt/brooks

      - name: Upload deployment files to VM
        id: scp_upload_1
        continue-on-error: true
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.VM_HOST }}
          username: ${{ secrets.VM_SSH_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: 22
          timeout: 120s
          command_timeout: 180s
          overwrite: true
          source: ".env.production,infra/docker-compose.prod.yml,infra/caddy/Caddyfile,infra/db/init/*"
          target: /opt/brooks/

      - name: Re-check SSH before retry upload
        if: steps.scp_upload_1.outcome == 'failure'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.VM_HOST }}
          username: ${{ secrets.VM_SSH_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: 22
          timeout: 30s
          command_timeout: 30s
          script: |
            set -e
            echo "Retry SSH handshake successful"
            echo "Host: $(hostname)"

      - name: Retry upload deployment files to VM
        if: steps.scp_upload_1.outcome == 'failure'
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.VM_HOST }}
          username: ${{ secrets.VM_SSH_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: 22
          timeout: 120s
          command_timeout: 180s
          overwrite: true
          source: ".env.production,infra/docker-compose.prod.yml,infra/caddy/Caddyfile,infra/db/init/*"
          target: /opt/brooks/

      - name: Clean VM and redeploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.VM_HOST }}
          username: ${{ secrets.VM_SSH_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: 22
          timeout: 300s
          command_timeout: 1200s
          script: |
            set -euo pipefail

            if docker ps >/dev/null 2>&1; then
              DOCKER="docker"
            else
              DOCKER="sudo docker"
            fi

            mkdir -p /opt/brooks/infra/caddy /opt/brooks/infra/db/init
            [ -f /opt/brooks/.env.production ] || { echo "/opt/brooks/.env.production missing"; exit 1; }

            cp /opt/brooks/.env.production /opt/brooks/.env

            sed -E -i '/^[A-Z_]+_DB_URL=/{
              s#sslmode=verify-full#sslmode=require#g;
              s#([?&])sslrootcert=[^&]*##g;
              s#\?&+#?#g;
              s#&&+#\&#g;
              s#[?&]$##g;
            }' /opt/brooks/.env

            for key in REDIS_HOST REDIS_PORT REDIS_PASSWORD REDIS_CACHE_TTL_SECONDS AUTH_DB_URL AUTH_DB_USER AUTH_DB_PASSWORD SOCIAL_DB_URL SOCIAL_DB_USER SOCIAL_DB_PASSWORD LISTS_DB_URL LISTS_DB_USER LISTS_DB_PASSWORD PINS_DB_URL PINS_DB_USER PINS_DB_PASSWORD MODERATION_DB_URL MODERATION_DB_USER MODERATION_DB_PASSWORD; do
              val="$(grep -E "^${key}=" /opt/brooks/.env | cut -d'=' -f2- || true)"
              if [ -z "${val}" ]; then
                echo "Missing required env var in /opt/brooks/.env: ${key}"
                exit 1
              fi
            done

            cd /opt/brooks

            AUTH_IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/brooks-auth-service:${{ github.sha }}"
            SOCIAL_IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/brooks-social-service:${{ github.sha }}"
            LISTS_IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/brooks-lists-service:${{ github.sha }}"
            PINS_IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/brooks-pins-service:${{ github.sha }}"
            MEDIA_IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/brooks-media-service:${{ github.sha }}"
            MODERATION_IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/brooks-moderation-service:${{ github.sha }}"
            NOTIFICATIONS_IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/brooks-notifications-service:${{ github.sha }}"
            FRONTEND_IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/brooks-frontend:${{ github.sha }}"

            cp /opt/brooks/.env /opt/brooks/.env.runtime
            sed -E -i '/^BROOKS_(AUTH|SOCIAL|LISTS|PINS|MEDIA|MODERATION|NOTIFICATIONS|FRONTEND)_IMAGE=/d' /opt/brooks/.env.runtime
            # Ensure low DB pressure defaults exist for Supabase direct connection.
            grep -q '^DB_MAX_POOL_SIZE=' /opt/brooks/.env.runtime || echo 'DB_MAX_POOL_SIZE=1' >> /opt/brooks/.env.runtime
            grep -q '^DB_MIN_IDLE=' /opt/brooks/.env.runtime || echo 'DB_MIN_IDLE=0' >> /opt/brooks/.env.runtime
            grep -q '^DB_CONNECTION_TIMEOUT_MS=' /opt/brooks/.env.runtime || echo 'DB_CONNECTION_TIMEOUT_MS=60000' >> /opt/brooks/.env.runtime
            grep -q '^FLYWAY_CONNECT_RETRIES=' /opt/brooks/.env.runtime || echo 'FLYWAY_CONNECT_RETRIES=30' >> /opt/brooks/.env.runtime
            printf "%s\n" \
              "BROOKS_AUTH_IMAGE=${AUTH_IMAGE}" \
              "BROOKS_SOCIAL_IMAGE=${SOCIAL_IMAGE}" \
              "BROOKS_LISTS_IMAGE=${LISTS_IMAGE}" \
              "BROOKS_PINS_IMAGE=${PINS_IMAGE}" \
              "BROOKS_MEDIA_IMAGE=${MEDIA_IMAGE}" \
              "BROOKS_MODERATION_IMAGE=${MODERATION_IMAGE}" \
              "BROOKS_NOTIFICATIONS_IMAGE=${NOTIFICATIONS_IMAGE}" \
              "BROOKS_FRONTEND_IMAGE=${FRONTEND_IMAGE}" \
              >> /opt/brooks/.env.runtime
            export BROOKS_AUTH_IMAGE="${AUTH_IMAGE}" BROOKS_SOCIAL_IMAGE="${SOCIAL_IMAGE}" BROOKS_LISTS_IMAGE="${LISTS_IMAGE}" BROOKS_PINS_IMAGE="${PINS_IMAGE}" BROOKS_MEDIA_IMAGE="${MEDIA_IMAGE}" BROOKS_MODERATION_IMAGE="${MODERATION_IMAGE}" BROOKS_NOTIFICATIONS_IMAGE="${NOTIFICATIONS_IMAGE}" BROOKS_FRONTEND_IMAGE="${FRONTEND_IMAGE}"

            # Remove previous deployment after successful handshake.
            $DOCKER compose --env-file /opt/brooks/.env.runtime -f /opt/brooks/infra/docker-compose.prod.yml down --remove-orphans || true
            $DOCKER rm -f $($DOCKER ps -aq) 2>/dev/null || true
            $DOCKER rmi -f $($DOCKER images -q '*/brooks-*') 2>/dev/null || true
            $DOCKER network prune -f || true
            $DOCKER system prune -af --volumes || true

            $DOCKER network create web 2>/dev/null || true
            $DOCKER network create brooks-network 2>/dev/null || true

            REGISTRY="${{ env.REGION }}-docker.pkg.dev"
            TOKEN="$(
              curl -fsS -H 'Metadata-Flavor: Google' \
                'http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token' \
              | python3 -c "import json,sys; print(json.load(sys.stdin)['access_token'])"
            )"
            [ -n "${TOKEN}" ] || { echo "Failed to get VM metadata access token"; exit 1; }
            printf '%s' "${TOKEN}" | $DOCKER login -u oauth2accesstoken --password-stdin "https://${REGISTRY}"

            $DOCKER compose --env-file /opt/brooks/.env.runtime -f /opt/brooks/infra/docker-compose.prod.yml pull

            # Start in phases to avoid DB connection spikes during Flyway startup.
            $DOCKER compose --env-file /opt/brooks/.env.runtime -f /opt/brooks/infra/docker-compose.prod.yml up -d --force-recreate redis
            for svc in auth-service social-service lists-service pins-service moderation-service; do
              $DOCKER compose --env-file /opt/brooks/.env.runtime -f /opt/brooks/infra/docker-compose.prod.yml up -d --force-recreate "$svc"
              sleep 30
            done
            for svc in media-service notifications-service frontend caddy; do
              $DOCKER compose --env-file /opt/brooks/.env.runtime -f /opt/brooks/infra/docker-compose.prod.yml up -d --force-recreate "$svc"
              sleep 5
            done

            sleep 30
            $DOCKER compose --env-file /opt/brooks/.env.runtime -f /opt/brooks/infra/docker-compose.prod.yml ps

      - name: Health check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.VM_HOST }}
          username: ${{ secrets.VM_SSH_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: 22
          timeout: 120s
          command_timeout: 300s
          script: |
            set -e
            if docker ps >/dev/null 2>&1; then
              DOCKER="docker"
            else
              DOCKER="sudo docker"
            fi

            check() {
              local name="$1"
              local url="$2"
              echo "Checking ${name}: ${url}"
              curl -f -m 10 "$url" >/dev/null
            }

            check "Auth" "http://localhost:8081/actuator/health"
            check "Social" "http://localhost:8082/actuator/health"
            check "Lists" "http://localhost:8083/actuator/health"
            check "Pins" "http://localhost:8084/actuator/health"
            check "Media" "http://localhost:8085/actuator/health"
            check "Moderation" "http://localhost:8086/actuator/health"
            check "Notifications" "http://localhost:8087/actuator/health"

            echo "Recent logs:"
            $DOCKER logs brooks-auth-service --tail 40
            $DOCKER logs brooks-lists-service --tail 40
            $DOCKER logs brooks-pins-service --tail 40
