name: üöÄ Deploy Brooks App

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

concurrency:
  group: deploy-brooks
  cancel-in-progress: false

env:
  PROJECT_ID: brooks-485009
  REGION: us-central1
  REPOSITORY: brooksar
  VM_ZONE: us-central1-c
  VM_NAME: instance-20260122-071626

jobs:
  validate-env:
    name: ‚úÖ Validate Environment
    runs-on: ubuntu-latest

    steps:
    - name: üì• Checkout Code
      uses: actions/checkout@v4

    - name: üîê Auth to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: ‚òÅÔ∏è Setup Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: üì¶ Fetch Environment Variables from Secret Manager
      run: |
        gcloud secrets versions access latest \
          --secret="brooks-env" \
          --project="${{ env.PROJECT_ID }}" > .env.production

    - name: üß™ Validate Required Variables
      run: |
        set -e
        REQUIRED_VARS=(
          "DATABASE_NAME"
          "DATABASE_USER"
          "DATABASE_PASSWORD"
          "BROOKS_JWT_SECRET"
          "AUTH0_ISSUER_URI"
          "AUTH0_AUDIENCE"
          "VITE_AUTH0_DOMAIN"
          "VITE_AUTH0_CLIENT_ID"
          "VITE_AUTH0_AUDIENCE"
          "VITE_AUTH0_REDIRECT_URI"
          "AUTH_DB_PASSWORD"
          "SOCIAL_DB_PASSWORD"
          "LISTS_DB_PASSWORD"
          "PINS_DB_PASSWORD"
          "MODERATION_DB_PASSWORD"
          "INTERNAL_SERVICE_KEY"
          "INTERNAL_SERVICE_KEYS"
          "INTERNAL_SERVICE_ALLOWED_NAMES"
          "INTERNAL_SERVICE_KEY_MAP"
        )

        missing=0
        for key in "${REQUIRED_VARS[@]}"; do
          if ! grep -E "^${key}=" .env.production >/dev/null; then
            echo "‚ùå Missing required env var: ${key}"
            missing=1
          fi
        done

        if [ "$missing" -ne 0 ]; then
          echo "‚ùå Environment validation failed."
          exit 1
        fi

        echo "‚úÖ Environment validation passed."

  deploy:
    name: üèóÔ∏è Build & Deploy
    runs-on: ubuntu-latest
    needs: validate-env

    steps:
    - name: üì• Checkout Code
      uses: actions/checkout@v4

    - name: üîê Auth to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: ‚òÅÔ∏è Setup Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: üîç Verify GCP Configuration
      run: |
        echo "üîç GCP Configuration:"
        echo "Project: $(gcloud config get-value project)"
        echo "Account: $(gcloud config get-value account)"
        echo "Region: ${{ env.REGION }}"
        echo "Repository: ${{ env.REPOSITORY }}"

    - name: üê≥ Configure Docker for Artifact Registry
      run: |
        echo "üê≥ Configuring Docker for Artifact Registry..."
        gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet
        echo "‚úÖ Docker configured"

    - name: üì¶ Fetch Environment Variables from Secret Manager
      run: |
        echo "üì¶ Fetching environment variables from Secret Manager..."
        gcloud secrets versions access latest \
          --secret="brooks-env" \
          --project="${{ env.PROJECT_ID }}" > .env.production

        echo "‚úÖ Environment variables fetched"
        echo "üìä Variables count: $(wc -l < .env.production)"

    - name: üèóÔ∏è Build & Push Auth Service Image
      run: |
        IMAGE_PATH="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/brooks-auth-service"

        echo "üèóÔ∏è Building auth-service Docker image..."
        echo "üìç Image path: $IMAGE_PATH"
        echo "üìç Tags: ${{ github.sha }}, latest"

        docker build \
          --progress=plain \
          --build-arg SERVICE_DIR=services/auth-service \
          -f infra/docker/Dockerfile.service \
          -t $IMAGE_PATH:${{ github.sha }} \
          -t $IMAGE_PATH:latest \
          .

        echo "üì§ Pushing auth-service images..."
        docker push $IMAGE_PATH:${{ github.sha }}
        docker push $IMAGE_PATH:latest

        echo "‚úÖ Auth-service images pushed"
        echo "BROOKS_AUTH_IMAGE=$IMAGE_PATH" >> $GITHUB_ENV

    - name: üèóÔ∏è Build & Push Social Service Image
      run: |
        IMAGE_PATH="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/brooks-social-service"

        echo "üèóÔ∏è Building social-service Docker image..."
        echo "üìç Image path: $IMAGE_PATH"

        docker build \
          --progress=plain \
          --build-arg SERVICE_DIR=services/social-service \
          -f infra/docker/Dockerfile.service \
          -t $IMAGE_PATH:${{ github.sha }} \
          -t $IMAGE_PATH:latest \
          .

        echo "üì§ Pushing social-service images..."
        docker push $IMAGE_PATH:${{ github.sha }}
        docker push $IMAGE_PATH:latest

        echo "‚úÖ Social-service images pushed"
        echo "BROOKS_SOCIAL_IMAGE=$IMAGE_PATH" >> $GITHUB_ENV

    - name: üèóÔ∏è Build & Push Lists Service Image
      run: |
        IMAGE_PATH="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/brooks-lists-service"

        echo "üèóÔ∏è Building lists-service Docker image..."
        echo "üìç Image path: $IMAGE_PATH"

        docker build \
          --progress=plain \
          --build-arg SERVICE_DIR=services/lists-service \
          -f infra/docker/Dockerfile.service \
          -t $IMAGE_PATH:${{ github.sha }} \
          -t $IMAGE_PATH:latest \
          .

        echo "üì§ Pushing lists-service images..."
        docker push $IMAGE_PATH:${{ github.sha }}
        docker push $IMAGE_PATH:latest

        echo "‚úÖ Lists-service images pushed"
        echo "BROOKS_LISTS_IMAGE=$IMAGE_PATH" >> $GITHUB_ENV

    - name: üèóÔ∏è Build & Push Pins Service Image
      run: |
        IMAGE_PATH="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/brooks-pins-service"

        echo "üèóÔ∏è Building pins-service Docker image..."
        echo "üìç Image path: $IMAGE_PATH"

        docker build \
          --progress=plain \
          --build-arg SERVICE_DIR=services/pins-service \
          -f infra/docker/Dockerfile.service \
          -t $IMAGE_PATH:${{ github.sha }} \
          -t $IMAGE_PATH:latest \
          .

        echo "üì§ Pushing pins-service images..."
        docker push $IMAGE_PATH:${{ github.sha }}
        docker push $IMAGE_PATH:latest

        echo "‚úÖ Pins-service images pushed"
        echo "BROOKS_PINS_IMAGE=$IMAGE_PATH" >> $GITHUB_ENV

    - name: üèóÔ∏è Build & Push Media Service Image
      run: |
        IMAGE_PATH="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/brooks-media-service"

        echo "üèóÔ∏è Building media-service Docker image..."
        echo "üìç Image path: $IMAGE_PATH"

        docker build \
          --progress=plain \
          --build-arg SERVICE_DIR=services/media-service \
          -f infra/docker/Dockerfile.service \
          -t $IMAGE_PATH:${{ github.sha }} \
          -t $IMAGE_PATH:latest \
          .

        echo "üì§ Pushing media-service images..."
        docker push $IMAGE_PATH:${{ github.sha }}
        docker push $IMAGE_PATH:latest

        echo "‚úÖ Media-service images pushed"
        echo "BROOKS_MEDIA_IMAGE=$IMAGE_PATH" >> $GITHUB_ENV

    - name: üèóÔ∏è Build & Push Moderation Service Image
      run: |
        IMAGE_PATH="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/brooks-moderation-service"

        echo "üèóÔ∏è Building moderation-service Docker image..."
        echo "üìç Image path: $IMAGE_PATH"

        docker build \
          --progress=plain \
          --build-arg SERVICE_DIR=services/moderation-service \
          -f infra/docker/Dockerfile.service \
          -t $IMAGE_PATH:${{ github.sha }} \
          -t $IMAGE_PATH:latest \
          .

        echo "üì§ Pushing moderation-service images..."
        docker push $IMAGE_PATH:${{ github.sha }}
        docker push $IMAGE_PATH:latest

        echo "‚úÖ Moderation-service images pushed"
        echo "BROOKS_MODERATION_IMAGE=$IMAGE_PATH" >> $GITHUB_ENV

    - name: üèóÔ∏è Build & Push Notifications Service Image
      run: |
        IMAGE_PATH="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/brooks-notifications-service"

        echo "üèóÔ∏è Building notifications-service Docker image..."
        echo "üìç Image path: $IMAGE_PATH"

        docker build \
          --progress=plain \
          --build-arg SERVICE_DIR=services/notifications-service \
          -f infra/docker/Dockerfile.service \
          -t $IMAGE_PATH:${{ github.sha }} \
          -t $IMAGE_PATH:latest \
          .

        echo "üì§ Pushing notifications-service images..."
        docker push $IMAGE_PATH:${{ github.sha }}
        docker push $IMAGE_PATH:latest

        echo "‚úÖ Notifications-service images pushed"
        echo "BROOKS_NOTIFICATIONS_IMAGE=$IMAGE_PATH" >> $GITHUB_ENV

    - name: üèóÔ∏è Build & Push Frontend Image
      run: |
        IMAGE_PATH="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/brooks-frontend"

        echo "üèóÔ∏è Building frontend Docker image..."
        echo "üìç Image path: $IMAGE_PATH"

        # Extract Vite variables for build args
        echo "üì¶ Extracting build arguments from .env.production..."
        VITE_AUTH_API_URL=$(grep "^VITE_AUTH_API_URL=" .env.production | cut -d'=' -f2- | tr -d '"' | tr -d "'")
        VITE_AUTH0_DOMAIN=$(grep "^VITE_AUTH0_DOMAIN=" .env.production | cut -d'=' -f2- | tr -d '"' | tr -d "'")
        VITE_AUTH0_CLIENT_ID=$(grep "^VITE_AUTH0_CLIENT_ID=" .env.production | cut -d'=' -f2- | tr -d '"' | tr -d "'")
        VITE_AUTH0_AUDIENCE=$(grep "^VITE_AUTH0_AUDIENCE=" .env.production | cut -d'=' -f2- | tr -d '"' | tr -d "'")
        VITE_AUTH0_REDIRECT_URI=$(grep "^VITE_AUTH0_REDIRECT_URI=" .env.production | cut -d'=' -f2- | tr -d '"' | tr -d "'")
        VITE_MAP_PROVIDER=$(grep "^VITE_MAP_PROVIDER=" .env.production | cut -d'=' -f2- | tr -d '"' | tr -d "'")
        VITE_GOOGLE_MAPS_KEY=$(grep "^VITE_GOOGLE_MAPS_KEY=" .env.production | cut -d'=' -f2- | tr -d '"' | tr -d "'")

        # Use defaults if empty
        VITE_AUTH0_REDIRECT_URI=${VITE_AUTH0_REDIRECT_URI:-"https://brooksweb.uk"}
        VITE_MAP_PROVIDER=${VITE_MAP_PROVIDER:-"leaflet"}

        docker build \
          --progress=plain \
          --build-arg VITE_AUTH_API_URL="${VITE_AUTH_API_URL}" \
          --build-arg VITE_AUTH0_DOMAIN="${VITE_AUTH0_DOMAIN}" \
          --build-arg VITE_AUTH0_CLIENT_ID="${VITE_AUTH0_CLIENT_ID}" \
          --build-arg VITE_AUTH0_AUDIENCE="${VITE_AUTH0_AUDIENCE}" \
          --build-arg VITE_AUTH0_REDIRECT_URI="${VITE_AUTH0_REDIRECT_URI}" \
          --build-arg VITE_SOCIAL_API_URL="https://brooksweb.uk/api/social" \
          --build-arg VITE_LISTS_API_URL="https://brooksweb.uk/api/lists" \
          --build-arg VITE_PINS_API_URL="https://brooksweb.uk/api/pins" \
          --build-arg VITE_MEDIA_API_URL="https://brooksweb.uk/api/media" \
          --build-arg VITE_MODERATION_API_URL="https://brooksweb.uk/api/moderation" \
          --build-arg VITE_NOTIFICATIONS_API_URL="https://brooksweb.uk/api/notifications" \
          --build-arg VITE_MAP_PROVIDER="${VITE_MAP_PROVIDER}" \
          --build-arg VITE_GOOGLE_MAPS_KEY="${VITE_GOOGLE_MAPS_KEY}" \
          --build-arg VITE_NOMINATIM_URL="https://nominatim.openstreetmap.org" \
          -f web/Dockerfile \
          -t $IMAGE_PATH:${{ github.sha }} \
          -t $IMAGE_PATH:latest \
          web/

        echo "üì§ Pushing frontend images..."
        docker push $IMAGE_PATH:${{ github.sha }}
        docker push $IMAGE_PATH:latest

        echo "‚úÖ Frontend images pushed"
        echo "FRONTEND_IMAGE=$IMAGE_PATH" >> $GITHUB_ENV

    - name: üèóÔ∏è Setup VM Directories
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_SSH_USER }}
        key: ${{ secrets.VM_SSH_KEY }}
        port: 22
        timeout: 30s
        command_timeout: 60s
        script: |
          echo "üèóÔ∏è Setting up directories for Brooks..."

          sudo mkdir -p /opt/brooks
          sudo mkdir -p /opt/brooks/infra/caddy
          sudo chown -R $USER:$USER /opt/brooks

          echo "‚úÖ VM directories ready"

    - name: üì§ Upload Files to VM
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_SSH_USER }}
        key: ${{ secrets.VM_SSH_KEY }}
        port: 22
        timeout: 30s
        command_timeout: 60s
        overwrite: true
        source: "infra/docker-compose.prod.yml,infra/caddy/Caddyfile,infra/db/init/*"
        target: /opt/brooks/

    - name: üì¶ Create .env file on VM from Secret Manager
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_SSH_USER }}
        key: ${{ secrets.VM_SSH_KEY }}
        port: 22
        timeout: 120s
        command_timeout: 300s
        script: |
          set -e
          PROJECT_ID="${{ env.PROJECT_ID }}"

          echo "üì¶ Creating .env file from Secret Manager..."

          gcloud secrets versions access latest \
            --secret="brooks-env" \
            --project="$PROJECT_ID" > /tmp/raw_env

          echo "üîß Cleaning .env file format..."
          grep -E '^[A-Za-z_][A-Za-z0-9_]*=' /tmp/raw_env > /opt/brooks/.env || {
            echo "‚ùå No valid environment variables found!"
            exit 1
          }

          rm -f /tmp/raw_env

          echo "‚úÖ .env file created successfully"
          echo "üìä Environment variables count: $(wc -l < /opt/brooks/.env)"

    - name: üöÄ Deploy Application
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_SSH_USER }}
        key: ${{ secrets.VM_SSH_KEY }}
        port: 22
        timeout: 300s
        command_timeout: 600s
        script: |
          set -e

          PROJECT_ID="${{ env.PROJECT_ID }}"
          REGION="${{ env.REGION }}"
          AUTH_IMAGE="${{ env.BROOKS_AUTH_IMAGE }}"
          SOCIAL_IMAGE="${{ env.BROOKS_SOCIAL_IMAGE }}"
          LISTS_IMAGE="${{ env.BROOKS_LISTS_IMAGE }}"
          PINS_IMAGE="${{ env.BROOKS_PINS_IMAGE }}"
          MEDIA_IMAGE="${{ env.BROOKS_MEDIA_IMAGE }}"
          MODERATION_IMAGE="${{ env.BROOKS_MODERATION_IMAGE }}"
          NOTIFICATIONS_IMAGE="${{ env.BROOKS_NOTIFICATIONS_IMAGE }}"
          FRONTEND_IMAGE="${{ env.FRONTEND_IMAGE }}"
          COMMIT_SHA="${{ github.sha }}"

          echo "üöÄ Deploying Brooks App..."
          echo "üìç Auth: $AUTH_IMAGE:$COMMIT_SHA"
          echo "üìç Social: $SOCIAL_IMAGE:$COMMIT_SHA"
          echo "üìç Lists: $LISTS_IMAGE:$COMMIT_SHA"
          echo "üìç Pins: $PINS_IMAGE:$COMMIT_SHA"
          echo "üìç Media: $MEDIA_IMAGE:$COMMIT_SHA"
          echo "üìç Moderation: $MODERATION_IMAGE:$COMMIT_SHA"
          echo "üìç Notifications: $NOTIFICATIONS_IMAGE:$COMMIT_SHA"
          echo "üìç Frontend: $FRONTEND_IMAGE:$COMMIT_SHA"

          cd /opt/brooks

          # Verify .env file
          if [ ! -f .env ]; then
            echo "‚ùå .env file not found!"
            exit 1
          fi

          echo "üîê Authenticating to Artifact Registry..."
          gcloud auth configure-docker $REGION-docker.pkg.dev --quiet

          echo "üåê Ensuring Docker network exists..."
          docker network inspect web >/dev/null 2>&1 || {
            echo "üÜï Creating web network..."
            docker network create web
          }

          echo "üìù Preparing runtime env file..."
          cp /opt/brooks/.env /opt/brooks/.env.runtime
          cat <<EOF >> /opt/brooks/.env.runtime
BROOKS_AUTH_IMAGE=${AUTH_IMAGE}:${COMMIT_SHA}
BROOKS_SOCIAL_IMAGE=${SOCIAL_IMAGE}:${COMMIT_SHA}
BROOKS_LISTS_IMAGE=${LISTS_IMAGE}:${COMMIT_SHA}
BROOKS_PINS_IMAGE=${PINS_IMAGE}:${COMMIT_SHA}
BROOKS_MEDIA_IMAGE=${MEDIA_IMAGE}:${COMMIT_SHA}
BROOKS_MODERATION_IMAGE=${MODERATION_IMAGE}:${COMMIT_SHA}
BROOKS_NOTIFICATIONS_IMAGE=${NOTIFICATIONS_IMAGE}:${COMMIT_SHA}
BROOKS_FRONTEND_IMAGE=${FRONTEND_IMAGE}:${COMMIT_SHA}
EOF

          echo "üì¶ Pulling latest images..."
          docker compose --env-file /opt/brooks/.env.runtime -f /opt/brooks/infra/docker-compose.prod.yml pull

          echo "üîÑ Deploying application..."
          docker compose --env-file /opt/brooks/.env.runtime -f /opt/brooks/infra/docker-compose.prod.yml up -d --force-recreate

          echo "‚è≥ Waiting for services to be healthy..."
          sleep 45

          echo "üìä Container status:"
          docker compose -f /opt/brooks/infra/docker-compose.prod.yml ps

          echo "üîß Reloading Caddy configuration..."
          if docker ps --format "{{.Names}}" | rg -q "^brooks-caddy$"; then
            docker exec brooks-caddy caddy reload --config /etc/caddy/Caddyfile || {
              echo "‚ùå Caddy reload failed, retrying..."
              sleep 5
              docker exec brooks-caddy caddy reload --config /etc/caddy/Caddyfile
            }
          else
            echo "‚ÑπÔ∏è Caddy container not found; skipping reload"
          fi

          echo "‚úÖ Deployment completed successfully!"

    - name: üîç Health Check
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_SSH_USER }}
        key: ${{ secrets.VM_SSH_KEY }}
        port: 22
        timeout: 120s
        command_timeout: 300s
        script: |
          set -e

          echo "üîç Running health checks..."

          sleep 20

          # Pins service health check
          echo "üìç Pins health check:"
          curl -f -m 10 http://localhost:8084/actuator/health && echo "‚úÖ Pins OK" || echo "‚ùå Pins FAIL"

          # Frontend health check
          echo "üìç Frontend health check:"
          curl -f -m 10 http://localhost:3000/health && echo "‚úÖ Frontend OK" || echo "‚ùå Frontend FAIL"

          # External check
          echo "üìç External health check:"
          curl -f -m 10 http://${{ secrets.VM_HOST }}/ && echo "‚úÖ External OK" || echo "‚ùå External FAIL"

          echo "üìã Application logs:"
          echo "=== Pins logs ==="
          docker logs brooks-pins-service --tail 20
          echo "=== Frontend logs ==="
          docker logs brooks-frontend --tail 20

          echo "üéØ Deployment verification complete!"

    - name: ‚ùå Rollback on Failure
      if: failure()
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_SSH_USER }}
        key: ${{ secrets.VM_SSH_KEY }}
        port: 22
        timeout: 120s
        command_timeout: 300s
        script: |
          set -e

          echo "‚ùå Deployment failed, initiating rollback..."

          cd /opt/brooks

          echo "üìù Preparing rollback env file..."
          cp /opt/brooks/.env /opt/brooks/.env.runtime
          cat <<EOF >> /opt/brooks/.env.runtime
BROOKS_AUTH_IMAGE=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/brooks-auth-service:latest
BROOKS_SOCIAL_IMAGE=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/brooks-social-service:latest
BROOKS_LISTS_IMAGE=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/brooks-lists-service:latest
BROOKS_PINS_IMAGE=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/brooks-pins-service:latest
BROOKS_MEDIA_IMAGE=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/brooks-media-service:latest
BROOKS_MODERATION_IMAGE=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/brooks-moderation-service:latest
BROOKS_NOTIFICATIONS_IMAGE=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/brooks-notifications-service:latest
BROOKS_FRONTEND_IMAGE=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/brooks-frontend:latest
EOF

          echo "üì¶ Pulling fallback images..."
          docker compose --env-file /opt/brooks/.env.runtime -f /opt/brooks/infra/docker-compose.prod.yml pull

          echo "üîÑ Rolling back to previous version..."
          docker compose --env-file /opt/brooks/.env.runtime -f /opt/brooks/infra/docker-compose.prod.yml up -d --force-recreate

          echo "üîß Reloading Caddy..."
          if docker ps --format "{{.Names}}" | rg -q "^brooks-caddy$"; then
            docker exec brooks-caddy caddy reload --config /etc/caddy/Caddyfile
          else
            echo "‚ÑπÔ∏è Caddy container not found; skipping reload"
          fi

          echo "üìä Rollback status:"
          docker compose -f /opt/brooks/infra/docker-compose.prod.yml ps

          echo "‚ö†Ô∏è Rollback completed - check logs for issues"
