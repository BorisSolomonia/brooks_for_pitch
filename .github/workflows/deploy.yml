name: ğŸš€ Deploy Brooks App

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

concurrency:
  group: deploy-brooks
  cancel-in-progress: false

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: ${{ secrets.GCP_REGION }}
  REPOSITORY: ${{ secrets.GCP_ARTIFACT_REPOSITORY }}
  VM_ZONE: ${{ secrets.GCP_VM_ZONE }}
  VM_NAME: ${{ secrets.GCP_VM_NAME }}
  ENV_SECRET_NAME: ${{ secrets.GCP_ENV_SECRET_NAME }}

jobs:
  validate-env:
    name: âœ… Validate Environment
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ” Auth to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: â˜ï¸ Setup Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: ğŸ§­ Resolve required runtime variables
      run: |
        set -euo pipefail
        PROJECT_ID="${{ env.PROJECT_ID }}"
        if [ -z "$PROJECT_ID" ]; then
          PROJECT_ID="${CLOUDSDK_CORE_PROJECT:-}"
        fi
        if [ -z "$PROJECT_ID" ]; then
          echo "âŒ PROJECT_ID is empty. Set repo variable GCP_PROJECT_ID."
          exit 1
        fi
        REGION="${{ env.REGION }}"
        if [ -z "$REGION" ]; then
          echo "âŒ REGION is empty. Set repo variable GCP_REGION."
          exit 1
        fi
        REPOSITORY="${{ env.REPOSITORY }}"
        if [ -z "$REPOSITORY" ]; then
          echo "âŒ REPOSITORY is empty. Set repo variable GCP_ARTIFACT_REPOSITORY."
          exit 1
        fi
        ENV_SECRET_NAME="${{ env.ENV_SECRET_NAME }}"
        if [ -z "$ENV_SECRET_NAME" ]; then
          echo "âŒ ENV_SECRET_NAME is empty. Set secret GCP_ENV_SECRET_NAME."
          exit 1
        fi
        echo "PROJECT_ID=$PROJECT_ID" >> $GITHUB_ENV
        echo "REGION=$REGION" >> $GITHUB_ENV
        echo "REPOSITORY=$REPOSITORY" >> $GITHUB_ENV
        echo "ENV_SECRET_NAME=$ENV_SECRET_NAME" >> $GITHUB_ENV

    - name: ğŸ“¦ Fetch Environment Variables from Secret Manager
      run: |
        gcloud secrets versions access latest \
          --secret="${{ env.ENV_SECRET_NAME }}" \
          --project="${{ env.PROJECT_ID }}" > .env.production

    - name: ğŸ§ª Validate Required Variables
      run: |
        set -e
        REQUIRED_VARS=(
          "POSTGRES_USER"
          "POSTGRES_PASSWORD"
          "AUTH_DB_URL"
          "SOCIAL_DB_URL"
          "LISTS_DB_URL"
          "PINS_DB_URL"
          "MODERATION_DB_URL"
          "AUTH_DB_USER"
          "SOCIAL_DB_USER"
          "LISTS_DB_USER"
          "PINS_DB_USER"
          "MODERATION_DB_USER"
          "AUTH_DB_PASSWORD"
          "SOCIAL_DB_PASSWORD"
          "LISTS_DB_PASSWORD"
          "PINS_DB_PASSWORD"
          "MODERATION_DB_PASSWORD"
          "AUTH_DB_NAME"
          "SOCIAL_DB_NAME"
          "LISTS_DB_NAME"
          "PINS_DB_NAME"
          "MODERATION_DB_NAME"
          "BROOKS_JWT_SECRET"
          "BROOKS_JWT_ISSUER"
          "BROOKS_JWT_ACCESS_TTL"
          "BROOKS_JWT_REFRESH_TTL"
          "AUTH0_ISSUER_URI"
          "AUTH0_AUDIENCE"
          "BROOKS_WEB_ORIGINS"
          "INTERNAL_SERVICE_KEY"
          "INTERNAL_SERVICE_KEYS"
          "INTERNAL_SERVICE_ALLOWED_NAMES"
          "INTERNAL_SERVICE_KEY_MAP"
          "INTERNAL_SERVICE_NAME"
          "SOCIAL_SERVICE_URL"
          "LISTS_SERVICE_URL"
          "BROOKS_BUCKET_SIZE_DEG"
          "BROOKS_CLEANUP_ENABLED"
          "BROOKS_CLEANUP_BATCH_SIZE"
          "BROOKS_CLEANUP_RETENTION_DAYS"
          "BROOKS_CLEANUP_CRON"
          "MEDIA_UPLOAD_BASE_URL"
          "VITE_AUTH_API_URL"
          "VITE_AUTH0_DOMAIN"
          "VITE_AUTH0_CLIENT_ID"
          "VITE_AUTH0_AUDIENCE"
          "VITE_AUTH0_REDIRECT_URI"
          "VITE_SOCIAL_API_URL"
          "VITE_LISTS_API_URL"
          "VITE_PINS_API_URL"
          "VITE_MEDIA_API_URL"
          "VITE_MODERATION_API_URL"
          "VITE_NOTIFICATIONS_API_URL"
          "VITE_MAP_PROVIDER"
          "VITE_NOMINATIM_URL"
          "VITE_LEAFLET_TILE_URL"
          "VITE_LEAFLET_ATTRIBUTION"
          "VITE_DEFAULT_CENTER_LAT"
          "VITE_DEFAULT_CENTER_LNG"
          "REDIS_HOST"
          "REDIS_PORT"
          "REDIS_PASSWORD"
          "REDIS_CACHE_TTL_SECONDS"
        )

        missing=0
        for key in "${REQUIRED_VARS[@]}"; do
          if ! grep -E "^${key}=" .env.production >/dev/null; then
            echo "âŒ Missing required env var: ${key}"
            missing=1
          fi
        done

        if [ "$missing" -ne 0 ]; then
          echo "âŒ Environment validation failed."
          exit 1
        fi

        echo "âœ… Environment validation passed."

  deploy:
    name: ğŸ—ï¸ Build & Deploy
    runs-on: ubuntu-latest
    needs: validate-env

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ” Auth to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: â˜ï¸ Setup Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: ğŸ§­ Resolve required runtime variables
      run: |
        set -euo pipefail
        PROJECT_ID="${{ env.PROJECT_ID }}"
        if [ -z "$PROJECT_ID" ]; then
          PROJECT_ID="${CLOUDSDK_CORE_PROJECT:-}"
        fi
        if [ -z "$PROJECT_ID" ]; then
          echo "âŒ PROJECT_ID is empty. Set repo variable GCP_PROJECT_ID."
          exit 1
        fi
        REGION="${{ env.REGION }}"
        if [ -z "$REGION" ]; then
          echo "âŒ REGION is empty. Set repo variable GCP_REGION."
          exit 1
        fi
        REPOSITORY="${{ env.REPOSITORY }}"
        if [ -z "$REPOSITORY" ]; then
          echo "âŒ REPOSITORY is empty. Set repo variable GCP_ARTIFACT_REPOSITORY."
          exit 1
        fi
        ENV_SECRET_NAME="${{ env.ENV_SECRET_NAME }}"
        if [ -z "$ENV_SECRET_NAME" ]; then
          echo "âŒ ENV_SECRET_NAME is empty. Set secret GCP_ENV_SECRET_NAME."
          exit 1
        fi
        echo "PROJECT_ID=$PROJECT_ID" >> $GITHUB_ENV
        echo "REGION=$REGION" >> $GITHUB_ENV
        echo "REPOSITORY=$REPOSITORY" >> $GITHUB_ENV
        echo "ENV_SECRET_NAME=$ENV_SECRET_NAME" >> $GITHUB_ENV

    - name: ğŸ” Verify GCP Configuration
      run: |
        echo "ğŸ” GCP Configuration:"
        echo "Project: $(gcloud config get-value project)"
        echo "Account: $(gcloud config get-value account)"
        echo "Region: ${{ env.REGION }}"
        echo "Repository: ${{ env.REPOSITORY }}"

    - name: ğŸ³ Configure Docker for Artifact Registry
      run: |
        echo "ğŸ³ Configuring Docker for Artifact Registry..."
        gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet
        echo "âœ… Docker configured"

    - name: ğŸ“¦ Fetch Environment Variables from Secret Manager
      run: |
        echo "ğŸ“¦ Fetching environment variables from Secret Manager..."
        gcloud secrets versions access latest \
          --secret="brooks-env" \
          --project="${{ env.PROJECT_ID }}" > .env.production

        echo "âœ… Environment variables fetched"
        echo "ğŸ“Š Variables count: $(wc -l < .env.production)"

    - name: ğŸ—ï¸ Build & Push Auth Service Image
      run: |
        IMAGE_PATH="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/brooks-auth-service"

        echo "ğŸ—ï¸ Building auth-service Docker image..."
        echo "ğŸ“ Image path: $IMAGE_PATH"
        echo "ğŸ“ Tags: ${{ github.sha }}, latest"

        docker build \
          --progress=plain \
          --build-arg SERVICE_DIR=services/auth-service \
          -f infra/docker/Dockerfile.service \
          -t $IMAGE_PATH:${{ github.sha }} \
          -t $IMAGE_PATH:latest \
          .

        echo "ğŸ“¤ Pushing auth-service images..."
        docker push $IMAGE_PATH:${{ github.sha }}
        docker push $IMAGE_PATH:latest

        echo "âœ… Auth-service images pushed"
        echo "BROOKS_AUTH_IMAGE=$IMAGE_PATH" >> $GITHUB_ENV

    - name: ğŸ—ï¸ Build & Push Social Service Image
      run: |
        IMAGE_PATH="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/brooks-social-service"

        echo "ğŸ—ï¸ Building social-service Docker image..."
        echo "ğŸ“ Image path: $IMAGE_PATH"

        docker build \
          --progress=plain \
          --build-arg SERVICE_DIR=services/social-service \
          -f infra/docker/Dockerfile.service \
          -t $IMAGE_PATH:${{ github.sha }} \
          -t $IMAGE_PATH:latest \
          .

        echo "ğŸ“¤ Pushing social-service images..."
        docker push $IMAGE_PATH:${{ github.sha }}
        docker push $IMAGE_PATH:latest

        echo "âœ… Social-service images pushed"
        echo "BROOKS_SOCIAL_IMAGE=$IMAGE_PATH" >> $GITHUB_ENV

    - name: ğŸ—ï¸ Build & Push Lists Service Image
      run: |
        IMAGE_PATH="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/brooks-lists-service"

        echo "ğŸ—ï¸ Building lists-service Docker image..."
        echo "ğŸ“ Image path: $IMAGE_PATH"

        docker build \
          --progress=plain \
          --build-arg SERVICE_DIR=services/lists-service \
          -f infra/docker/Dockerfile.service \
          -t $IMAGE_PATH:${{ github.sha }} \
          -t $IMAGE_PATH:latest \
          .

        echo "ğŸ“¤ Pushing lists-service images..."
        docker push $IMAGE_PATH:${{ github.sha }}
        docker push $IMAGE_PATH:latest

        echo "âœ… Lists-service images pushed"
        echo "BROOKS_LISTS_IMAGE=$IMAGE_PATH" >> $GITHUB_ENV

    - name: ğŸ—ï¸ Build & Push Pins Service Image
      run: |
        IMAGE_PATH="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/brooks-pins-service"

        echo "ğŸ—ï¸ Building pins-service Docker image..."
        echo "ğŸ“ Image path: $IMAGE_PATH"

        docker build \
          --progress=plain \
          --build-arg SERVICE_DIR=services/pins-service \
          -f infra/docker/Dockerfile.service \
          -t $IMAGE_PATH:${{ github.sha }} \
          -t $IMAGE_PATH:latest \
          .

        echo "ğŸ“¤ Pushing pins-service images..."
        docker push $IMAGE_PATH:${{ github.sha }}
        docker push $IMAGE_PATH:latest

        echo "âœ… Pins-service images pushed"
        echo "BROOKS_PINS_IMAGE=$IMAGE_PATH" >> $GITHUB_ENV

    - name: ğŸ—ï¸ Build & Push Media Service Image
      run: |
        IMAGE_PATH="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/brooks-media-service"

        echo "ğŸ—ï¸ Building media-service Docker image..."
        echo "ğŸ“ Image path: $IMAGE_PATH"

        docker build \
          --progress=plain \
          --build-arg SERVICE_DIR=services/media-service \
          -f infra/docker/Dockerfile.service \
          -t $IMAGE_PATH:${{ github.sha }} \
          -t $IMAGE_PATH:latest \
          .

        echo "ğŸ“¤ Pushing media-service images..."
        docker push $IMAGE_PATH:${{ github.sha }}
        docker push $IMAGE_PATH:latest

        echo "âœ… Media-service images pushed"
        echo "BROOKS_MEDIA_IMAGE=$IMAGE_PATH" >> $GITHUB_ENV

    - name: ğŸ—ï¸ Build & Push Moderation Service Image
      run: |
        IMAGE_PATH="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/brooks-moderation-service"

        echo "ğŸ—ï¸ Building moderation-service Docker image..."
        echo "ğŸ“ Image path: $IMAGE_PATH"

        docker build \
          --progress=plain \
          --build-arg SERVICE_DIR=services/moderation-service \
          -f infra/docker/Dockerfile.service \
          -t $IMAGE_PATH:${{ github.sha }} \
          -t $IMAGE_PATH:latest \
          .

        echo "ğŸ“¤ Pushing moderation-service images..."
        docker push $IMAGE_PATH:${{ github.sha }}
        docker push $IMAGE_PATH:latest

        echo "âœ… Moderation-service images pushed"
        echo "BROOKS_MODERATION_IMAGE=$IMAGE_PATH" >> $GITHUB_ENV

    - name: ğŸ—ï¸ Build & Push Notifications Service Image
      run: |
        IMAGE_PATH="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/brooks-notifications-service"

        echo "ğŸ—ï¸ Building notifications-service Docker image..."
        echo "ğŸ“ Image path: $IMAGE_PATH"

        docker build \
          --progress=plain \
          --build-arg SERVICE_DIR=services/notifications-service \
          -f infra/docker/Dockerfile.service \
          -t $IMAGE_PATH:${{ github.sha }} \
          -t $IMAGE_PATH:latest \
          .

        echo "ğŸ“¤ Pushing notifications-service images..."
        docker push $IMAGE_PATH:${{ github.sha }}
        docker push $IMAGE_PATH:latest

        echo "âœ… Notifications-service images pushed"
        echo "BROOKS_NOTIFICATIONS_IMAGE=$IMAGE_PATH" >> $GITHUB_ENV

    - name: ğŸ—ï¸ Build & Push Frontend Image
      run: |
        IMAGE_PATH="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/brooks-frontend"

        echo "ğŸ—ï¸ Building frontend Docker image..."
        echo "ğŸ“ Image path: $IMAGE_PATH"

        # Extract Vite variables for build args
        echo "ğŸ“¦ Extracting build arguments from .env.production..."
        VITE_AUTH_API_URL=$(grep "^VITE_AUTH_API_URL=" .env.production | cut -d'=' -f2- | tr -d '"' | tr -d "'")
        VITE_AUTH0_DOMAIN=$(grep "^VITE_AUTH0_DOMAIN=" .env.production | cut -d'=' -f2- | tr -d '"' | tr -d "'")
        VITE_AUTH0_CLIENT_ID=$(grep "^VITE_AUTH0_CLIENT_ID=" .env.production | cut -d'=' -f2- | tr -d '"' | tr -d "'")
        VITE_AUTH0_AUDIENCE=$(grep "^VITE_AUTH0_AUDIENCE=" .env.production | cut -d'=' -f2- | tr -d '"' | tr -d "'")
        VITE_AUTH0_REDIRECT_URI=$(grep "^VITE_AUTH0_REDIRECT_URI=" .env.production | cut -d'=' -f2- | tr -d '"' | tr -d "'")
        VITE_SOCIAL_API_URL=$(grep "^VITE_SOCIAL_API_URL=" .env.production | cut -d'=' -f2- | tr -d '"' | tr -d "'")
        VITE_LISTS_API_URL=$(grep "^VITE_LISTS_API_URL=" .env.production | cut -d'=' -f2- | tr -d '"' | tr -d "'")
        VITE_PINS_API_URL=$(grep "^VITE_PINS_API_URL=" .env.production | cut -d'=' -f2- | tr -d '"' | tr -d "'")
        VITE_MEDIA_API_URL=$(grep "^VITE_MEDIA_API_URL=" .env.production | cut -d'=' -f2- | tr -d '"' | tr -d "'")
        VITE_MODERATION_API_URL=$(grep "^VITE_MODERATION_API_URL=" .env.production | cut -d'=' -f2- | tr -d '"' | tr -d "'")
        VITE_NOTIFICATIONS_API_URL=$(grep "^VITE_NOTIFICATIONS_API_URL=" .env.production | cut -d'=' -f2- | tr -d '"' | tr -d "'")
        VITE_MAP_PROVIDER=$(grep "^VITE_MAP_PROVIDER=" .env.production | cut -d'=' -f2- | tr -d '"' | tr -d "'")
        VITE_GOOGLE_MAPS_KEY=$(grep "^VITE_GOOGLE_MAPS_KEY=" .env.production | cut -d'=' -f2- | tr -d '"' | tr -d "'")
        VITE_NOMINATIM_URL=$(grep "^VITE_NOMINATIM_URL=" .env.production | cut -d'=' -f2- | tr -d '"' | tr -d "'")
        VITE_LEAFLET_TILE_URL=$(grep "^VITE_LEAFLET_TILE_URL=" .env.production | cut -d'=' -f2- | tr -d '"' | tr -d "'")
        VITE_LEAFLET_ATTRIBUTION=$(grep "^VITE_LEAFLET_ATTRIBUTION=" .env.production | cut -d'=' -f2- | tr -d '"' | tr -d "'")
        VITE_DEFAULT_CENTER_LAT=$(grep "^VITE_DEFAULT_CENTER_LAT=" .env.production | cut -d'=' -f2- | tr -d '"' | tr -d "'")
        VITE_DEFAULT_CENTER_LNG=$(grep "^VITE_DEFAULT_CENTER_LNG=" .env.production | cut -d'=' -f2- | tr -d '"' | tr -d "'")

        docker build \
          --progress=plain \
          --build-arg VITE_AUTH_API_URL="${VITE_AUTH_API_URL}" \
          --build-arg VITE_AUTH0_DOMAIN="${VITE_AUTH0_DOMAIN}" \
          --build-arg VITE_AUTH0_CLIENT_ID="${VITE_AUTH0_CLIENT_ID}" \
          --build-arg VITE_AUTH0_AUDIENCE="${VITE_AUTH0_AUDIENCE}" \
          --build-arg VITE_AUTH0_REDIRECT_URI="${VITE_AUTH0_REDIRECT_URI}" \
          --build-arg VITE_SOCIAL_API_URL="${VITE_SOCIAL_API_URL}" \
          --build-arg VITE_LISTS_API_URL="${VITE_LISTS_API_URL}" \
          --build-arg VITE_PINS_API_URL="${VITE_PINS_API_URL}" \
          --build-arg VITE_MEDIA_API_URL="${VITE_MEDIA_API_URL}" \
          --build-arg VITE_MODERATION_API_URL="${VITE_MODERATION_API_URL}" \
          --build-arg VITE_NOTIFICATIONS_API_URL="${VITE_NOTIFICATIONS_API_URL}" \
          --build-arg VITE_MAP_PROVIDER="${VITE_MAP_PROVIDER}" \
          --build-arg VITE_GOOGLE_MAPS_KEY="${VITE_GOOGLE_MAPS_KEY}" \
          --build-arg VITE_NOMINATIM_URL="${VITE_NOMINATIM_URL}" \
          --build-arg VITE_LEAFLET_TILE_URL="${VITE_LEAFLET_TILE_URL}" \
          --build-arg VITE_LEAFLET_ATTRIBUTION="${VITE_LEAFLET_ATTRIBUTION}" \
          --build-arg VITE_DEFAULT_CENTER_LAT="${VITE_DEFAULT_CENTER_LAT}" \
          --build-arg VITE_DEFAULT_CENTER_LNG="${VITE_DEFAULT_CENTER_LNG}" \
          -f web/Dockerfile \
          -t $IMAGE_PATH:${{ github.sha }} \
          -t $IMAGE_PATH:latest \
          web/

        echo "ğŸ“¤ Pushing frontend images..."
        docker push $IMAGE_PATH:${{ github.sha }}
        docker push $IMAGE_PATH:latest

        echo "âœ… Frontend images pushed"
        echo "FRONTEND_IMAGE=$IMAGE_PATH" >> $GITHUB_ENV

    - name: ğŸ—ï¸ Setup VM Directories
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_SSH_USER }}
        key: ${{ secrets.VM_SSH_KEY }}
        port: 22
        timeout: 30s
        command_timeout: 60s
        script: |
          echo "ğŸ—ï¸ Setting up directories for Brooks..."

          sudo mkdir -p /opt/brooks
          sudo mkdir -p /opt/brooks/infra/caddy
          sudo mkdir -p /opt/brooks/infra/db/init
          sudo chown -R $USER:$USER /opt/brooks

          echo "âœ… VM directories ready"

    - name: ğŸ“¤ Upload Files to VM
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_SSH_USER }}
        key: ${{ secrets.VM_SSH_KEY }}
        port: 22
        timeout: 30s
        command_timeout: 60s
        overwrite: true
        source: "infra/docker-compose.prod.yml,infra/caddy/Caddyfile,infra/db/init/*"
        target: /opt/brooks/

    - name: ğŸ“¦ Create .env file on VM from Secret Manager
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_SSH_USER }}
        key: ${{ secrets.VM_SSH_KEY }}
        port: 22
        timeout: 120s
        command_timeout: 300s
        script: |
          set -e
          PROJECT_ID="${{ env.PROJECT_ID }}"

          echo "ğŸ“¦ Creating .env file from Secret Manager..."

          gcloud secrets versions access latest \
            --secret="${{ env.ENV_SECRET_NAME }}" \
            --project="$PROJECT_ID" > /tmp/raw_env

          echo "ğŸ”§ Cleaning .env file format..."
          grep -E '^[A-Za-z_][A-Za-z0-9_]*=' /tmp/raw_env > /opt/brooks/.env || {
            echo "âŒ No valid environment variables found!"
            exit 1
          }

          rm -f /tmp/raw_env

          echo "âœ… .env file created successfully"
          echo "ğŸ“Š Environment variables count: $(wc -l < /opt/brooks/.env)"

    - name: ğŸš€ Deploy Application
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_SSH_USER }}
        key: ${{ secrets.VM_SSH_KEY }}
        port: 22
        timeout: 300s
        command_timeout: 600s
        script: |
          set -e

          PROJECT_ID="${{ env.PROJECT_ID }}"
          REGION="${{ env.REGION }}"
          AUTH_IMAGE="${{ env.BROOKS_AUTH_IMAGE }}"
          SOCIAL_IMAGE="${{ env.BROOKS_SOCIAL_IMAGE }}"
          LISTS_IMAGE="${{ env.BROOKS_LISTS_IMAGE }}"
          PINS_IMAGE="${{ env.BROOKS_PINS_IMAGE }}"
          MEDIA_IMAGE="${{ env.BROOKS_MEDIA_IMAGE }}"
          MODERATION_IMAGE="${{ env.BROOKS_MODERATION_IMAGE }}"
          NOTIFICATIONS_IMAGE="${{ env.BROOKS_NOTIFICATIONS_IMAGE }}"
          FRONTEND_IMAGE="${{ env.FRONTEND_IMAGE }}"
          COMMIT_SHA="${{ github.sha }}"

          echo "ğŸš€ Deploying Brooks App..."
          echo "ğŸ“ Auth: $AUTH_IMAGE:$COMMIT_SHA"
          echo "ğŸ“ Social: $SOCIAL_IMAGE:$COMMIT_SHA"
          echo "ğŸ“ Lists: $LISTS_IMAGE:$COMMIT_SHA"
          echo "ğŸ“ Pins: $PINS_IMAGE:$COMMIT_SHA"
          echo "ğŸ“ Media: $MEDIA_IMAGE:$COMMIT_SHA"
          echo "ğŸ“ Moderation: $MODERATION_IMAGE:$COMMIT_SHA"
          echo "ğŸ“ Notifications: $NOTIFICATIONS_IMAGE:$COMMIT_SHA"
          echo "ğŸ“ Frontend: $FRONTEND_IMAGE:$COMMIT_SHA"

          cd /opt/brooks

          # Verify .env file
          if [ ! -f .env ]; then
            echo "âŒ .env file not found!"
            exit 1
          fi

          echo "ğŸ” Authenticating to Artifact Registry..."
          gcloud auth configure-docker $REGION-docker.pkg.dev --quiet

          echo "ğŸŒ Ensuring Docker network exists..."
          docker network inspect web >/dev/null 2>&1 || {
            echo "ğŸ†• Creating web network..."
            docker network create web
          }

          echo "ğŸ“ Preparing runtime env file..."
          cp /opt/brooks/.env /opt/brooks/.env.runtime
          printf "%s\n" \
            "BROOKS_AUTH_IMAGE=${AUTH_IMAGE}:${COMMIT_SHA}" \
            "BROOKS_SOCIAL_IMAGE=${SOCIAL_IMAGE}:${COMMIT_SHA}" \
            "BROOKS_LISTS_IMAGE=${LISTS_IMAGE}:${COMMIT_SHA}" \
            "BROOKS_PINS_IMAGE=${PINS_IMAGE}:${COMMIT_SHA}" \
            "BROOKS_MEDIA_IMAGE=${MEDIA_IMAGE}:${COMMIT_SHA}" \
            "BROOKS_MODERATION_IMAGE=${MODERATION_IMAGE}:${COMMIT_SHA}" \
            "BROOKS_NOTIFICATIONS_IMAGE=${NOTIFICATIONS_IMAGE}:${COMMIT_SHA}" \
            "BROOKS_FRONTEND_IMAGE=${FRONTEND_IMAGE}:${COMMIT_SHA}" \
            >> /opt/brooks/.env.runtime

          echo "ğŸ§¹ Removing legacy containers that may conflict..."
          docker rm -f brooks-frontend brooks-backend caddy brooks-caddy >/dev/null 2>&1 || true

          echo "ğŸ“¦ Pulling latest images..."
          docker compose --env-file /opt/brooks/.env.runtime -f /opt/brooks/infra/docker-compose.prod.yml pull

          echo "ğŸ”„ Deploying application..."
          docker compose --env-file /opt/brooks/.env.runtime -f /opt/brooks/infra/docker-compose.prod.yml up -d --force-recreate

          echo "â³ Waiting for services to be healthy..."
          sleep 45

          echo "ğŸ“Š Container status:"
          docker compose --env-file /opt/brooks/.env.runtime -f /opt/brooks/infra/docker-compose.prod.yml ps

          echo "ğŸ”§ Reloading Caddy configuration..."
          if docker ps --format "{{.Names}}" | grep -q "^brooks-caddy$"; then
            docker exec brooks-caddy caddy reload --config /etc/caddy/Caddyfile || {
              echo "âŒ Caddy reload failed, retrying..."
              sleep 5
              docker exec brooks-caddy caddy reload --config /etc/caddy/Caddyfile
            }
          else
            echo "â„¹ï¸ Caddy container not found; skipping reload"
          fi

          echo "âœ… Deployment completed successfully!"

    - name: ğŸ” Health Check
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_SSH_USER }}
        key: ${{ secrets.VM_SSH_KEY }}
        port: 22
        timeout: 120s
        command_timeout: 300s
        script: |
          set -e

          echo "ğŸ” Running health checks..."

          sleep 20

          # Pins service health check
          echo "ğŸ“ Pins health check:"
          curl -f -m 10 http://localhost:8084/actuator/health && echo "âœ… Pins OK" || echo "âŒ Pins FAIL"

          # Frontend health check
          echo "ğŸ“ Frontend health check:"
          curl -f -m 10 http://localhost:3000/health && echo "âœ… Frontend OK" || echo "âŒ Frontend FAIL"

          # External check
          echo "ğŸ“ External health check:"
          curl -f -m 10 http://${{ secrets.VM_HOST }}/ && echo "âœ… External OK" || echo "âŒ External FAIL"

          echo "ğŸ“‹ Application logs:"
          echo "=== Pins logs ==="
          docker logs brooks-pins-service --tail 20
          echo "=== Frontend logs ==="
          docker logs brooks-frontend --tail 20

          echo "ğŸ¯ Deployment verification complete!"

    - name: âŒ Rollback on Failure
      if: failure()
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_SSH_USER }}
        key: ${{ secrets.VM_SSH_KEY }}
        port: 22
        timeout: 120s
        command_timeout: 300s
        script: |
          set -e

          echo "âŒ Deployment failed, initiating rollback..."

          cd /opt/brooks

          if [ -z "${{ env.REGION }}" ] || [ -z "${{ env.PROJECT_ID }}" ] || [ -z "${{ env.REPOSITORY }}" ]; then
            echo "âŒ REGION/PROJECT_ID/REPOSITORY missing. Set GCP_REGION, GCP_PROJECT_ID, GCP_ARTIFACT_REPOSITORY."
            exit 1
          fi

          echo "ğŸ“ Preparing rollback env file..."
          cp /opt/brooks/.env /opt/brooks/.env.runtime
          printf "%s\n" \
            "BROOKS_AUTH_IMAGE=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/brooks-auth-service:latest" \
            "BROOKS_SOCIAL_IMAGE=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/brooks-social-service:latest" \
            "BROOKS_LISTS_IMAGE=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/brooks-lists-service:latest" \
            "BROOKS_PINS_IMAGE=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/brooks-pins-service:latest" \
            "BROOKS_MEDIA_IMAGE=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/brooks-media-service:latest" \
            "BROOKS_MODERATION_IMAGE=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/brooks-moderation-service:latest" \
            "BROOKS_NOTIFICATIONS_IMAGE=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/brooks-notifications-service:latest" \
            "BROOKS_FRONTEND_IMAGE=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/brooks-frontend:latest" \
            >> /opt/brooks/.env.runtime

          echo "ğŸ§¹ Removing legacy containers that may conflict..."
          docker rm -f brooks-frontend brooks-backend caddy brooks-caddy >/dev/null 2>&1 || true

          echo "ğŸ“¦ Pulling fallback images..."
          docker compose --env-file /opt/brooks/.env.runtime -f /opt/brooks/infra/docker-compose.prod.yml pull

          echo "ğŸ”„ Rolling back to previous version..."
          docker compose --env-file /opt/brooks/.env.runtime -f /opt/brooks/infra/docker-compose.prod.yml up -d --force-recreate

          echo "ğŸ”§ Reloading Caddy..."
          if docker ps --format "{{.Names}}" | grep -q "^brooks-caddy$"; then
            docker exec brooks-caddy caddy reload --config /etc/caddy/Caddyfile
          else
            echo "â„¹ï¸ Caddy container not found; skipping reload"
          fi

          echo "ğŸ“Š Rollback status:"
          docker compose --env-file /opt/brooks/.env.runtime -f /opt/brooks/infra/docker-compose.prod.yml ps

          echo "âš ï¸ Rollback completed - check logs for issues"
