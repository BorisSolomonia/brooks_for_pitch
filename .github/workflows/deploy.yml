name: ğŸš€ Deploy Brooks App

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

concurrency:
  group: deploy-brooks
  cancel-in-progress: false

env:
  PROJECT_ID: brooks-485009
  REGION: us-central1
  REPOSITORY: brooksar
  VM_ZONE: us-central1-c
  VM_NAME: instance-20260122-071626

jobs:
  deploy:
    name: ğŸ—ï¸ Build & Deploy
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ” Auth to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: â˜ï¸ Setup Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: ğŸ” Verify GCP Configuration
      run: |
        echo "ğŸ” GCP Configuration:"
        echo "Project: $(gcloud config get-value project)"
        echo "Account: $(gcloud config get-value account)"
        echo "Region: ${{ env.REGION }}"
        echo "Repository: ${{ env.REPOSITORY }}"

    - name: ğŸ³ Configure Docker for Artifact Registry
      run: |
        echo "ğŸ³ Configuring Docker for Artifact Registry..."
        gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet
        echo "âœ… Docker configured"

    - name: ğŸ“¦ Fetch Environment Variables from Secret Manager
      run: |
        echo "ğŸ“¦ Fetching environment variables from Secret Manager..."
        gcloud secrets versions access latest \
          --secret="brooks-env" \
          --project="${{ env.PROJECT_ID }}" > .env.production

        echo "âœ… Environment variables fetched"
        echo "ğŸ“Š Variables count: $(wc -l < .env.production)"

    - name: ğŸ—ï¸ Build & Push Backend Image
      run: |
        IMAGE_PATH="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/brooks-backend"

        echo "ğŸ—ï¸ Building backend Docker image..."
        echo "ğŸ“ Image path: $IMAGE_PATH"
        echo "ğŸ“ Tags: ${{ github.sha }}, latest"

        docker build \
          --progress=plain \
          -f server/Dockerfile \
          -t $IMAGE_PATH:${{ github.sha }} \
          -t $IMAGE_PATH:latest \
          server/

        echo "ğŸ“¤ Pushing backend images..."
        docker push $IMAGE_PATH:${{ github.sha }}
        docker push $IMAGE_PATH:latest

        echo "âœ… Backend images pushed"
        echo "BACKEND_IMAGE=$IMAGE_PATH" >> $GITHUB_ENV

    - name: ğŸ—ï¸ Build & Push Frontend Image
      run: |
        IMAGE_PATH="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/brooks-frontend"

        echo "ğŸ—ï¸ Building frontend Docker image..."
        echo "ğŸ“ Image path: $IMAGE_PATH"

        # Extract Vite variables for build args
        echo "ğŸ“¦ Extracting build arguments from .env.production..."
        VITE_AUTH_API_URL=$(grep "^VITE_AUTH_API_URL=" .env.production | cut -d'=' -f2- | tr -d '"' | tr -d "'")
        VITE_AUTH0_DOMAIN=$(grep "^VITE_AUTH0_DOMAIN=" .env.production | cut -d'=' -f2- | tr -d '"' | tr -d "'")
        VITE_AUTH0_CLIENT_ID=$(grep "^VITE_AUTH0_CLIENT_ID=" .env.production | cut -d'=' -f2- | tr -d '"' | tr -d "'")
        VITE_AUTH0_AUDIENCE=$(grep "^VITE_AUTH0_AUDIENCE=" .env.production | cut -d'=' -f2- | tr -d '"' | tr -d "'")
        VITE_AUTH0_REDIRECT_URI=$(grep "^VITE_AUTH0_REDIRECT_URI=" .env.production | cut -d'=' -f2- | tr -d '"' | tr -d "'")
        VITE_MAP_PROVIDER=$(grep "^VITE_MAP_PROVIDER=" .env.production | cut -d'=' -f2- | tr -d '"' | tr -d "'")
        VITE_GOOGLE_MAPS_KEY=$(grep "^VITE_GOOGLE_MAPS_KEY=" .env.production | cut -d'=' -f2- | tr -d '"' | tr -d "'")

        # Use defaults if empty
        VITE_AUTH0_REDIRECT_URI=${VITE_AUTH0_REDIRECT_URI:-"https://brooksweb.uk"}
        VITE_MAP_PROVIDER=${VITE_MAP_PROVIDER:-"leaflet"}

        docker build \
          --progress=plain \
          --build-arg VITE_AUTH_API_URL="${VITE_AUTH_API_URL}" \
          --build-arg VITE_AUTH0_DOMAIN="${VITE_AUTH0_DOMAIN}" \
          --build-arg VITE_AUTH0_CLIENT_ID="${VITE_AUTH0_CLIENT_ID}" \
          --build-arg VITE_AUTH0_AUDIENCE="${VITE_AUTH0_AUDIENCE}" \
          --build-arg VITE_AUTH0_REDIRECT_URI="${VITE_AUTH0_REDIRECT_URI}" \
          --build-arg VITE_SOCIAL_API_URL="https://brooksweb.uk/api/social" \
          --build-arg VITE_LISTS_API_URL="https://brooksweb.uk/api/lists" \
          --build-arg VITE_PINS_API_URL="https://brooksweb.uk/api/pins" \
          --build-arg VITE_MEDIA_API_URL="https://brooksweb.uk/api/media" \
          --build-arg VITE_MODERATION_API_URL="https://brooksweb.uk/api/moderation" \
          --build-arg VITE_NOTIFICATIONS_API_URL="https://brooksweb.uk/api/notifications" \
          --build-arg VITE_MAP_PROVIDER="${VITE_MAP_PROVIDER}" \
          --build-arg VITE_GOOGLE_MAPS_KEY="${VITE_GOOGLE_MAPS_KEY}" \
          --build-arg VITE_NOMINATIM_URL="https://nominatim.openstreetmap.org" \
          -f web/Dockerfile \
          -t $IMAGE_PATH:${{ github.sha }} \
          -t $IMAGE_PATH:latest \
          web/

        echo "ğŸ“¤ Pushing frontend images..."
        docker push $IMAGE_PATH:${{ github.sha }}
        docker push $IMAGE_PATH:latest

        echo "âœ… Frontend images pushed"
        echo "FRONTEND_IMAGE=$IMAGE_PATH" >> $GITHUB_ENV

    - name: ğŸ—ï¸ Setup VM Directories
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_SSH_USER }}
        key: ${{ secrets.VM_SSH_KEY }}
        port: 22
        timeout: 30s
        command_timeout: 60s
        script: |
          echo "ğŸ—ï¸ Setting up directories for Brooks..."

          sudo mkdir -p /opt/brooks
          sudo mkdir -p /opt/brooks/infra/caddy
          sudo chown -R $USER:$USER /opt/brooks

          echo "âœ… VM directories ready"

    - name: ğŸ“¤ Upload Files to VM
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_SSH_USER }}
        key: ${{ secrets.VM_SSH_KEY }}
        port: 22
        timeout: 30s
        command_timeout: 60s
        overwrite: true
        source: "docker-compose.yml,infra/caddy/Caddyfile,db/schema.sql"
        target: /opt/brooks/

    - name: ğŸ”§ Prepare Caddy on VM
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_SSH_USER }}
        key: ${{ secrets.VM_SSH_KEY }}
        port: 22
        timeout: 120s
        command_timeout: 300s
        script: |
          set -e

          echo "ğŸ”§ Preparing Caddy..."
          sudo mkdir -p /opt/caddy/config /opt/caddy/data

          # Ensure shared network exists
          docker network inspect web >/dev/null 2>&1 || docker network create web

          if [ ! -f /opt/caddy/docker-compose.yml ]; then
            cat > /tmp/caddy-compose.yml <<'EOF'
          version: '3.8'

          services:
            caddy:
              image: caddy:2-alpine
              container_name: caddy
              restart: unless-stopped
              ports:
                - "80:80"
                - "443:443"
                - "443:443/udp"
              volumes:
                - /opt/caddy/config:/etc/caddy
                - /opt/caddy/data:/data
                - /opt/brooks/infra/caddy/Caddyfile:/etc/caddy/Caddyfile:ro
              networks:
                - web

          networks:
            web:
              external: true
          EOF
            sudo mv /tmp/caddy-compose.yml /opt/caddy/docker-compose.yml
          fi

          sudo docker compose -f /opt/caddy/docker-compose.yml up -d
          echo "âœ… Caddy prepared"

    - name: ğŸ“¦ Create .env file on VM from Secret Manager
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_SSH_USER }}
        key: ${{ secrets.VM_SSH_KEY }}
        port: 22
        timeout: 120s
        command_timeout: 300s
        script: |
          set -e
          PROJECT_ID="${{ env.PROJECT_ID }}"

          echo "ğŸ“¦ Creating .env file from Secret Manager..."

          gcloud secrets versions access latest \
            --secret="brooks-env" \
            --project="$PROJECT_ID" > /tmp/raw_env

          echo "ğŸ”§ Cleaning .env file format..."
          grep -E '^[A-Za-z_][A-Za-z0-9_]*=' /tmp/raw_env > /opt/brooks/.env || {
            echo "âŒ No valid environment variables found!"
            exit 1
          }

          rm -f /tmp/raw_env

          echo "âœ… .env file created successfully"
          echo "ğŸ“Š Environment variables count: $(wc -l < /opt/brooks/.env)"

    - name: ğŸš€ Deploy Application
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_SSH_USER }}
        key: ${{ secrets.VM_SSH_KEY }}
        port: 22
        timeout: 300s
        command_timeout: 600s
        script: |
          set -e

          PROJECT_ID="${{ env.PROJECT_ID }}"
          REGION="${{ env.REGION }}"
          BACKEND_IMAGE="${{ env.BACKEND_IMAGE }}"
          FRONTEND_IMAGE="${{ env.FRONTEND_IMAGE }}"
          COMMIT_SHA="${{ github.sha }}"

          echo "ğŸš€ Deploying Brooks App..."
          echo "ğŸ“ Backend: $BACKEND_IMAGE:$COMMIT_SHA"
          echo "ğŸ“ Frontend: $FRONTEND_IMAGE:$COMMIT_SHA"

          cd /opt/brooks

          # Verify .env file
          if [ ! -f .env ]; then
            echo "âŒ .env file not found!"
            exit 1
          fi

          echo "ğŸ” Authenticating to Artifact Registry..."
          gcloud auth configure-docker $REGION-docker.pkg.dev --quiet

          echo "ğŸŒ Ensuring Docker network exists..."
          docker network inspect web >/dev/null 2>&1 || {
            echo "ğŸ†• Creating web network..."
            docker network create web
          }

          echo "ğŸ“ Updating compose file with commit SHA..."
          sed -i "s|image: ${BACKEND_IMAGE}:.*|image: ${BACKEND_IMAGE}:${COMMIT_SHA}|g" docker-compose.yml
          sed -i "s|image: ${FRONTEND_IMAGE}:.*|image: ${FRONTEND_IMAGE}:${COMMIT_SHA}|g" docker-compose.yml

          echo "ğŸ“¦ Pulling latest images..."
          docker compose pull

          echo "ğŸ”„ Deploying application..."
          docker compose up -d --force-recreate

          echo "â³ Waiting for services to be healthy..."
          sleep 45

          echo "ğŸ“Š Container status:"
          docker compose ps

          echo "ğŸ”§ Reloading Caddy configuration..."
          if docker ps --format "{{.Names}}" | rg -q "^caddy$"; then
            docker exec caddy caddy reload --config /etc/caddy/Caddyfile || {
              echo "âŒ Caddy reload failed, retrying..."
              sleep 5
              docker exec caddy caddy reload --config /etc/caddy/Caddyfile
            }
          else
            echo "â„¹ï¸ Caddy container not found; skipping reload"
          fi

          echo "âœ… Deployment completed successfully!"

    - name: ğŸ” Health Check
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_SSH_USER }}
        key: ${{ secrets.VM_SSH_KEY }}
        port: 22
        timeout: 120s
        command_timeout: 300s
        script: |
          set -e

          echo "ğŸ” Running health checks..."

          sleep 20

          # Backend health check
          echo "ğŸ“ Backend health check:"
          curl -f -m 10 http://localhost:8080/actuator/health && echo "âœ… Backend OK" || echo "âŒ Backend FAIL"

          # Frontend health check
          echo "ğŸ“ Frontend health check:"
          curl -f -m 10 http://localhost:3000/health && echo "âœ… Frontend OK" || echo "âŒ Frontend FAIL"

          # External check
          echo "ğŸ“ External health check:"
          curl -f -m 10 http://${{ secrets.VM_HOST }}/ && echo "âœ… External OK" || echo "âŒ External FAIL"

          echo "ğŸ“‹ Application logs:"
          echo "=== Backend logs ==="
          docker logs brooks-backend --tail 20
          echo "=== Frontend logs ==="
          docker logs brooks-frontend --tail 20

          echo "ğŸ¯ Deployment verification complete!"

    - name: âŒ Rollback on Failure
      if: failure()
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_SSH_USER }}
        key: ${{ secrets.VM_SSH_KEY }}
        port: 22
        timeout: 120s
        command_timeout: 300s
        script: |
          set -e

          echo "âŒ Deployment failed, initiating rollback..."

          cd /opt/brooks

          sed -i "s|image: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/brooks-backend:.*|image: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/brooks-backend:latest|g" docker-compose.yml
          sed -i "s|image: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/brooks-frontend:.*|image: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/brooks-frontend:latest|g" docker-compose.yml

          echo "ğŸ“¦ Pulling fallback images..."
          docker compose pull

          echo "ğŸ”„ Rolling back to previous version..."
          docker compose up -d --force-recreate

          echo "ğŸ”§ Reloading Caddy..."
          if docker ps --format "{{.Names}}" | rg -q "^caddy$"; then
            docker exec caddy caddy reload --config /etc/caddy/Caddyfile
          else
            echo "â„¹ï¸ Caddy container not found; skipping reload"
          fi

          echo "ğŸ“Š Rollback status:"
          docker compose ps

          echo "âš ï¸ Rollback completed - check logs for issues"
