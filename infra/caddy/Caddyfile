# Brooks App - Main Domain with HTTPS (Microservices)
brooksweb.uk, www.brooksweb.uk {
  log {
    output stdout
    format console
    level INFO
  }

  # Enable gzip and zstd compression
  encode gzip zstd

  # API routes -> Microservices
  handle /api/auth/actuator/health {
    reverse_proxy auth-service:8081
  }

  handle /api/social/actuator/health {
    reverse_proxy social-service:8082
  }

  handle /api/lists/actuator/health {
    reverse_proxy lists-service:8083
  }

  handle /api/pins/actuator/health {
    reverse_proxy pins-service:8084
  }

  handle /api/media/actuator/health {
    reverse_proxy media-service:8085
  }

  handle /api/moderation/actuator/health {
    reverse_proxy moderation-service:8086
  }

  handle /api/notifications/actuator/health {
    reverse_proxy notifications-service:8087
  }

  handle_path /api/auth/* {
    reverse_proxy auth-service:8081
  }

  handle_path /api/social/* {
    reverse_proxy social-service:8082
  }

  handle_path /api/lists/* {
    reverse_proxy lists-service:8083
  }

  handle_path /api/pins/* {
    reverse_proxy pins-service:8084
  }

  handle_path /api/media/* {
    reverse_proxy media-service:8085
  }

  handle_path /api/moderation/* {
    reverse_proxy moderation-service:8086
  }

  handle_path /api/notifications/* {
    reverse_proxy notifications-service:8087
  }

  # Management/Actuator endpoints -> Pins service (primary)
  handle /actuator/* {
    reverse_proxy pins-service:8084
  }

  # All other routes -> Frontend (React app on port 3000)
  handle {
    reverse_proxy frontend:3000 {
      # Health check
      health_uri /health
      health_interval 30s
      health_timeout 5s
    }
  }

  # Security headers
  header {
    -Server
    X-Content-Type-Options nosniff
    X-Frame-Options SAMEORIGIN
    X-XSS-Protection "1; mode=block"
    Referrer-Policy "strict-origin-when-cross-origin"
    Permissions-Policy "accelerometer=(), camera=(), geolocation=(self), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=()"
  }
}

# HTTP endpoint - serve application directly (SSL via Cloudflare)
http://brooksweb.uk, http://www.brooksweb.uk, :80 {
  log {
    output stdout
    format console
    level INFO
  }

  # Enable gzip compression
  encode gzip zstd

  # Health check
  @health path /health
  respond @health "OK" 200

  # API routes -> Microservices
  handle_path /api/auth/* {
    reverse_proxy auth-service:8081
  }

  handle_path /api/social/* {
    reverse_proxy social-service:8082
  }

  handle_path /api/lists/* {
    reverse_proxy lists-service:8083
  }

  handle_path /api/pins/* {
    reverse_proxy pins-service:8084
  }

  handle_path /api/media/* {
    reverse_proxy media-service:8085
  }

  handle_path /api/moderation/* {
    reverse_proxy moderation-service:8086
  }

  handle_path /api/notifications/* {
    reverse_proxy notifications-service:8087
  }

  # Management/Actuator endpoints
  handle /actuator/* {
    reverse_proxy pins-service:8084
  }

  # All other routes -> Frontend
  handle {
    reverse_proxy frontend:3000
  }

  # Security headers
  header {
    -Server
    X-Content-Type-Options nosniff
    X-Frame-Options SAMEORIGIN
    Referrer-Policy "strict-origin-when-cross-origin"
  }
}
