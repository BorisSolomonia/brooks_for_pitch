services:
  redis:
    image: redis:7-alpine
    container_name: brooks-redis
    restart: unless-stopped
    command: ["redis-server", "--appendonly", "yes", "--requirepass", "${REDIS_PASSWORD}"]
    environment:
      REDIS_PASSWORD: ${REDIS_PASSWORD?REDIS_PASSWORD must be set in .env file}
    volumes:
      - brooks-redis-data:/data
    networks:
      - brooks-network
  caddy:
    image: caddy:2
    container_name: brooks-caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-data:/data
      - caddy-config:/config
    depends_on:
      - frontend
      - auth-service
      - social-service
      - lists-service
      - pins-service
      - media-service
      - moderation-service
      - notifications-service
    networks:
      - web

  auth-service:
    image: ${BROOKS_AUTH_IMAGE?BROOKS_AUTH_IMAGE must be set in .env file}
    container_name: brooks-auth-service
    restart: unless-stopped
    expose:
      - "8081"
    environment:
      SERVER_PORT: "8081"
      AUTH_DB_URL: ${AUTH_DB_URL?AUTH_DB_URL must be set in .env file}
      AUTH_DB_USER: ${AUTH_DB_USER?AUTH_DB_USER must be set in .env file}
      AUTH_DB_PASSWORD: ${AUTH_DB_PASSWORD?AUTH_DB_PASSWORD must be set in .env file}
      SPRING_DATASOURCE_HIKARI_MAXIMUMPOOLSIZE: ${DB_MAX_POOL_SIZE:-2}
      SPRING_DATASOURCE_HIKARI_MINIMUMIDLE: ${DB_MIN_IDLE:-0}
      SPRING_DATASOURCE_HIKARI_CONNECTIONTIMEOUT: ${DB_CONNECTION_TIMEOUT_MS:-60000}
      SPRING_DATASOURCE_HIKARI_INITIALIZATIONFAILTIMEOUT: -1
      SPRING_FLYWAY_CONNECT_RETRIES: ${FLYWAY_CONNECT_RETRIES:-30}
      SPRING_FLYWAY_CONNECT_RETRIES_INTERVAL: 5
      AUTH0_ISSUER_URI: ${AUTH0_ISSUER_URI?AUTH0_ISSUER_URI must be set in .env file}
      AUTH0_AUDIENCE: ${AUTH0_AUDIENCE?AUTH0_AUDIENCE must be set in .env file}
      BROOKS_JWT_ISSUER: ${BROOKS_JWT_ISSUER?BROOKS_JWT_ISSUER must be set in .env file}
      BROOKS_JWT_SECRET: ${BROOKS_JWT_SECRET?BROOKS_JWT_SECRET must be set in .env file}
      BROOKS_JWT_ACCESS_TTL: ${BROOKS_JWT_ACCESS_TTL?BROOKS_JWT_ACCESS_TTL must be set in .env file}
      BROOKS_JWT_REFRESH_TTL: ${BROOKS_JWT_REFRESH_TTL?BROOKS_JWT_REFRESH_TTL must be set in .env file}
      BROOKS_WEB_ORIGINS: ${BROOKS_WEB_ORIGINS?BROOKS_WEB_ORIGINS must be set in .env file}
      INTERNAL_SERVICE_KEYS: ${INTERNAL_SERVICE_KEYS}
      INTERNAL_SERVICE_ALLOWED_NAMES: ${INTERNAL_SERVICE_ALLOWED_NAMES}
      INTERNAL_SERVICE_KEY_MAP: ${INTERNAL_SERVICE_KEY_MAP}
    depends_on:
      - redis
    networks:
      - brooks-network
      - web

  social-service:
    image: ${BROOKS_SOCIAL_IMAGE?BROOKS_SOCIAL_IMAGE must be set in .env file}
    container_name: brooks-social-service
    restart: unless-stopped
    expose:
      - "8082"
    environment:
      SERVER_PORT: "8082"
      SOCIAL_DB_URL: ${SOCIAL_DB_URL?SOCIAL_DB_URL must be set in .env file}
      SOCIAL_DB_USER: ${SOCIAL_DB_USER?SOCIAL_DB_USER must be set in .env file}
      SOCIAL_DB_PASSWORD: ${SOCIAL_DB_PASSWORD?SOCIAL_DB_PASSWORD must be set in .env file}
      SPRING_DATASOURCE_HIKARI_MAXIMUMPOOLSIZE: ${DB_MAX_POOL_SIZE:-2}
      SPRING_DATASOURCE_HIKARI_MINIMUMIDLE: ${DB_MIN_IDLE:-0}
      SPRING_DATASOURCE_HIKARI_CONNECTIONTIMEOUT: ${DB_CONNECTION_TIMEOUT_MS:-60000}
      SPRING_DATASOURCE_HIKARI_INITIALIZATIONFAILTIMEOUT: -1
      SPRING_FLYWAY_CONNECT_RETRIES: ${FLYWAY_CONNECT_RETRIES:-30}
      SPRING_FLYWAY_CONNECT_RETRIES_INTERVAL: 5
      AUTH0_ISSUER_URI: ${AUTH0_ISSUER_URI?AUTH0_ISSUER_URI must be set in .env file}
      AUTH0_AUDIENCE: ${AUTH0_AUDIENCE?AUTH0_AUDIENCE must be set in .env file}
      BROOKS_WEB_ORIGINS: ${BROOKS_WEB_ORIGINS?BROOKS_WEB_ORIGINS must be set in .env file}
      INTERNAL_SERVICE_KEYS: ${INTERNAL_SERVICE_KEYS}
      INTERNAL_SERVICE_ALLOWED_NAMES: ${INTERNAL_SERVICE_ALLOWED_NAMES}
      INTERNAL_SERVICE_KEY_MAP: ${INTERNAL_SERVICE_KEY_MAP}
    depends_on:
      - redis
    networks:
      - brooks-network
      - web

  lists-service:
    image: ${BROOKS_LISTS_IMAGE?BROOKS_LISTS_IMAGE must be set in .env file}
    container_name: brooks-lists-service
    restart: unless-stopped
    expose:
      - "8083"
    environment:
      SERVER_PORT: "8083"
      LISTS_DB_URL: ${LISTS_DB_URL?LISTS_DB_URL must be set in .env file}
      LISTS_DB_USER: ${LISTS_DB_USER?LISTS_DB_USER must be set in .env file}
      LISTS_DB_PASSWORD: ${LISTS_DB_PASSWORD?LISTS_DB_PASSWORD must be set in .env file}
      SPRING_DATASOURCE_HIKARI_MAXIMUMPOOLSIZE: ${DB_MAX_POOL_SIZE:-2}
      SPRING_DATASOURCE_HIKARI_MINIMUMIDLE: ${DB_MIN_IDLE:-0}
      SPRING_DATASOURCE_HIKARI_CONNECTIONTIMEOUT: ${DB_CONNECTION_TIMEOUT_MS:-60000}
      SPRING_DATASOURCE_HIKARI_INITIALIZATIONFAILTIMEOUT: -1
      SPRING_FLYWAY_CONNECT_RETRIES: ${FLYWAY_CONNECT_RETRIES:-30}
      SPRING_FLYWAY_CONNECT_RETRIES_INTERVAL: 5
      AUTH0_ISSUER_URI: ${AUTH0_ISSUER_URI?AUTH0_ISSUER_URI must be set in .env file}
      AUTH0_AUDIENCE: ${AUTH0_AUDIENCE?AUTH0_AUDIENCE must be set in .env file}
      BROOKS_WEB_ORIGINS: ${BROOKS_WEB_ORIGINS?BROOKS_WEB_ORIGINS must be set in .env file}
      INTERNAL_SERVICE_KEYS: ${INTERNAL_SERVICE_KEYS}
      INTERNAL_SERVICE_ALLOWED_NAMES: ${INTERNAL_SERVICE_ALLOWED_NAMES}
      INTERNAL_SERVICE_KEY_MAP: ${INTERNAL_SERVICE_KEY_MAP}
    depends_on:
      - redis
    networks:
      - brooks-network
      - web

  pins-service:
    image: ${BROOKS_PINS_IMAGE?BROOKS_PINS_IMAGE must be set in .env file}
    container_name: brooks-pins-service
    restart: unless-stopped
    expose:
      - "8084"
    environment:
      SERVER_PORT: "8084"
      PINS_DB_URL: ${PINS_DB_URL?PINS_DB_URL must be set in .env file}
      PINS_DB_USER: ${PINS_DB_USER?PINS_DB_USER must be set in .env file}
      PINS_DB_PASSWORD: ${PINS_DB_PASSWORD?PINS_DB_PASSWORD must be set in .env file}
      SPRING_DATASOURCE_HIKARI_MAXIMUMPOOLSIZE: ${DB_MAX_POOL_SIZE:-2}
      SPRING_DATASOURCE_HIKARI_MINIMUMIDLE: ${DB_MIN_IDLE:-0}
      SPRING_DATASOURCE_HIKARI_CONNECTIONTIMEOUT: ${DB_CONNECTION_TIMEOUT_MS:-60000}
      SPRING_DATASOURCE_HIKARI_INITIALIZATIONFAILTIMEOUT: -1
      SPRING_FLYWAY_CONNECT_RETRIES: ${FLYWAY_CONNECT_RETRIES:-30}
      SPRING_FLYWAY_CONNECT_RETRIES_INTERVAL: 5
      SOCIAL_SERVICE_URL: ${SOCIAL_SERVICE_URL?SOCIAL_SERVICE_URL must be set in .env file}
      LISTS_SERVICE_URL: ${LISTS_SERVICE_URL?LISTS_SERVICE_URL must be set in .env file}
      AUTH0_ISSUER_URI: ${AUTH0_ISSUER_URI?AUTH0_ISSUER_URI must be set in .env file}
      AUTH0_AUDIENCE: ${AUTH0_AUDIENCE?AUTH0_AUDIENCE must be set in .env file}
      BROOKS_WEB_ORIGINS: ${BROOKS_WEB_ORIGINS?BROOKS_WEB_ORIGINS must be set in .env file}
      INTERNAL_SERVICE_NAME: ${INTERNAL_SERVICE_NAME?INTERNAL_SERVICE_NAME must be set in .env file}
      INTERNAL_SERVICE_KEY: ${INTERNAL_SERVICE_KEY?INTERNAL_SERVICE_KEY must be set in .env file}
      BROOKS_BUCKET_SIZE_DEG: ${BROOKS_BUCKET_SIZE_DEG?BROOKS_BUCKET_SIZE_DEG must be set in .env file}
      BROOKS_CLEANUP_ENABLED: ${BROOKS_CLEANUP_ENABLED?BROOKS_CLEANUP_ENABLED must be set in .env file}
      BROOKS_CLEANUP_BATCH_SIZE: ${BROOKS_CLEANUP_BATCH_SIZE?BROOKS_CLEANUP_BATCH_SIZE must be set in .env file}
      BROOKS_CLEANUP_RETENTION_DAYS: ${BROOKS_CLEANUP_RETENTION_DAYS?BROOKS_CLEANUP_RETENTION_DAYS must be set in .env file}
      BROOKS_CLEANUP_CRON: ${BROOKS_CLEANUP_CRON?BROOKS_CLEANUP_CRON must be set in .env file}
      REDIS_HOST: ${REDIS_HOST?REDIS_HOST must be set in .env file}
      REDIS_PORT: ${REDIS_PORT?REDIS_PORT must be set in .env file}
      REDIS_PASSWORD: ${REDIS_PASSWORD?REDIS_PASSWORD must be set in .env file}
      REDIS_CACHE_TTL_SECONDS: ${REDIS_CACHE_TTL_SECONDS?REDIS_CACHE_TTL_SECONDS must be set in .env file}
    depends_on:
      - social-service
      - lists-service
      - redis
    networks:
      - brooks-network
      - web

  media-service:
    image: ${BROOKS_MEDIA_IMAGE?BROOKS_MEDIA_IMAGE must be set in .env file}
    container_name: brooks-media-service
    restart: unless-stopped
    expose:
      - "8085"
    environment:
      SERVER_PORT: "8085"
      AUTH0_ISSUER_URI: ${AUTH0_ISSUER_URI?AUTH0_ISSUER_URI must be set in .env file}
      AUTH0_AUDIENCE: ${AUTH0_AUDIENCE?AUTH0_AUDIENCE must be set in .env file}
      BROOKS_WEB_ORIGINS: ${BROOKS_WEB_ORIGINS?BROOKS_WEB_ORIGINS must be set in .env file}
      MEDIA_UPLOAD_BASE_URL: ${MEDIA_UPLOAD_BASE_URL?MEDIA_UPLOAD_BASE_URL must be set in .env file}
    networks:
      - brooks-network
      - web

  moderation-service:
    image: ${BROOKS_MODERATION_IMAGE?BROOKS_MODERATION_IMAGE must be set in .env file}
    container_name: brooks-moderation-service
    restart: unless-stopped
    expose:
      - "8086"
    environment:
      SERVER_PORT: "8086"
      MODERATION_DB_URL: ${MODERATION_DB_URL?MODERATION_DB_URL must be set in .env file}
      MODERATION_DB_USER: ${MODERATION_DB_USER?MODERATION_DB_USER must be set in .env file}
      MODERATION_DB_PASSWORD: ${MODERATION_DB_PASSWORD?MODERATION_DB_PASSWORD must be set in .env file}
      SPRING_DATASOURCE_HIKARI_MAXIMUMPOOLSIZE: ${DB_MAX_POOL_SIZE:-2}
      SPRING_DATASOURCE_HIKARI_MINIMUMIDLE: ${DB_MIN_IDLE:-0}
      SPRING_DATASOURCE_HIKARI_CONNECTIONTIMEOUT: ${DB_CONNECTION_TIMEOUT_MS:-60000}
      SPRING_DATASOURCE_HIKARI_INITIALIZATIONFAILTIMEOUT: -1
      SPRING_FLYWAY_CONNECT_RETRIES: ${FLYWAY_CONNECT_RETRIES:-30}
      SPRING_FLYWAY_CONNECT_RETRIES_INTERVAL: 5
      AUTH0_ISSUER_URI: ${AUTH0_ISSUER_URI?AUTH0_ISSUER_URI must be set in .env file}
      AUTH0_AUDIENCE: ${AUTH0_AUDIENCE?AUTH0_AUDIENCE must be set in .env file}
      BROOKS_WEB_ORIGINS: ${BROOKS_WEB_ORIGINS?BROOKS_WEB_ORIGINS must be set in .env file}
    depends_on:
      - redis
    networks:
      - brooks-network
      - web

  notifications-service:
    image: ${BROOKS_NOTIFICATIONS_IMAGE?BROOKS_NOTIFICATIONS_IMAGE must be set in .env file}
    container_name: brooks-notifications-service
    restart: unless-stopped
    expose:
      - "8087"
    environment:
      SERVER_PORT: "8087"
      AUTH0_ISSUER_URI: ${AUTH0_ISSUER_URI?AUTH0_ISSUER_URI must be set in .env file}
      AUTH0_AUDIENCE: ${AUTH0_AUDIENCE?AUTH0_AUDIENCE must be set in .env file}
      BROOKS_WEB_ORIGINS: ${BROOKS_WEB_ORIGINS?BROOKS_WEB_ORIGINS must be set in .env file}
    depends_on:
      - redis
    networks:
      - brooks-network
      - web

  frontend:
    image: ${BROOKS_FRONTEND_IMAGE?BROOKS_FRONTEND_IMAGE must be set in .env file}
    container_name: brooks-frontend
    restart: unless-stopped
    expose:
      - "3000"
    networks:
      - web

networks:
  brooks-network:
    driver: bridge
  web:
    driver: bridge

volumes:
  brooks-redis-data:
    driver: local
  caddy-data:
    driver: local
  caddy-config:
    driver: local
